<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Word Worm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; touch-action: none; }
        .tile {
            position: relative;
            transition: all 0.2s ease-in-out; -webkit-user-select: none; user-select: none;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .tile.selected {
            background: linear-gradient(45deg, #60a5fa, #3b82f6);
            color: white; transform: scale(1.08); border-color: #2563eb;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        #game-content.blurred, #modal-content.blurred { filter: blur(8px); transform: scale(0.95); transition: all 0.3s ease-in-out; }
        #game-content, #modal-content { transition: all 0.3s ease-in-out; }
        #line-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* Bonus Tile Styles */
        .bonus-label {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.65rem;
            font-weight: 900;
            color: white;
            padding: 0px 4px;
            border-radius: 4px;
        }
        .bonus-DL { background-color: #3b82f6 !important; } /* Blue */
        .bonus-TL { background-color: #ef4444 !important; } /* Red */
        .bonus-DW { background-color: #f59e0b !important; } /* Amber */
        .bonus-Time { background-color: #22c55e !important; } /* Green */
        
        /* Animations */
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .animate-pulse { animation: pulse 1s infinite; }
        @keyframes fly-to-score {
            0% { transform: translate(0, 0) scale(1.2); opacity: 1; }
            100% { transform: translate(0, -180px) scale(0.5); opacity: 0; }
        }
        .flying-score {
            position: absolute; background: linear-gradient(45deg, #facc15, #f59e0b); color: white;
            padding: 8px 16px; border-radius: 9999px; font-weight: bold; font-size: 1.25rem;
            z-index: 100; animation: fly-to-score 1.5s ease-in-out forwards; pointer-events: none;
        }
        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .current-letter { animation: pop-in 0.2s ease-out; }
        .modal-enter { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Tutorial Animation */
        .tutorial-tile.highlight {
            background: linear-gradient(45deg, #60a5fa, #3b82f6);
            color: white;
            transform: scale(1.08);
            border-color: #2563eb;
        }
        @keyframes fly-up-tutorial {
            0% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -200%) scale(0.5); opacity: 0; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .animate-bounce-slow {
            animation: bounce 1.5s infinite;
        }

        .particle {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #facc15;
            z-index: 101;
            animation: particle-anim 1.2s ease-out forwards;
        }

        @keyframes particle-anim {
            to {
                transform: var(--transform-end);
                opacity: 0;
            }
        }
        
        /* Dropdown Menu */
        .dropdown-menu {
            transition: all 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-slate-100 flex justify-center items-start md:items-center min-h-screen">

<div id="game-container" class="w-full max-w-sm mx-auto p-4 relative">
    <div id="menu-container" class="absolute top-4 right-4 z-30 hidden">
        <button id="menu-button" class="text-slate-700 p-2 transition-transform hover:scale-105">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                 <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
             </svg>
        </button>
        <div id="dropdown-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl origin-top-right" style="transform: scale(0.95); opacity: 0;">
            <a id="menu-home" href="#" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg><span class="ml-3">Home</span></a>
            <a id="menu-stats" href="#" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" /></svg><span class="ml-3">Your Stats</span></a>
            <a id="menu-leaderboard" href="#" class="flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="m6.115 5.19.319 1.913A6 6 0 0 0 8.11 10.36L9.75 12l-.387.775c-.217.433-.132.956.21 1.298l1.348 1.348c.21.21.329.497.329.795v1.089c0 .426.24.815.622 1.006l.153.076c.433.217.956.132 1.298-.21l.723-.723a8.7 8.7 0 0 0 2.288-4.042 1.087 1.087 0 0 0-.358-1.099l-1.33-1.108c-.251-.21-.582-.299-.905-.245l-1.17.195a1.125 1.125 0 0 1-.98-.314l-.295-.295a1.125 1.125 0 0 1 0-1.591l.13-.132a1.125 1.125 0 0 1 1.3-.21l.603.302a.809.809 0 0 0 1.086-1.086L14.25 7.5l1.256-.837a4.5 4.5 0 0 0 1.528-1.732l.146-.292M6.115 5.19A9 9 0 1 0 17.18 4.64M6.115 5.19A8.965 8.965 0 0 1 12 3c1.929 0 3.716.607 5.18 1.64" /></svg><span class="ml-3">Leaderboard</span></a>
        </div>
    </div>

    <div id="game-content">
        <div class="flex items-center justify-between mb-3">
            <div class="flex-grow flex items-center justify-center">
                <h1 class="text-3xl font-black text-slate-800 tracking-tighter flex items-center justify-center">
                    <img src="https://raw.githubusercontent.com/tputerio/word-rush-game/main/word-worm-logo.png" alt="Word Worm Logo" class="w-9 h-9 mr-2">
                    <span>Word Worm</span>
                </h1>
            </div>
        </div>
        <div id="scoreboard" class="grid grid-cols-3 items-center text-center bg-white rounded-xl shadow-lg p-2 mb-3">
            <div id="top-left-display">
                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">High</div>
                <div id="high-score" class="text-3xl font-black text-slate-400">0</div>
            </div>
            <div>
                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Score</div>
                <div id="score" class="text-3xl font-black text-slate-800">0</div>
            </div>
            <div id="timer-display">
                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Time</div>
                <div id="timer" class="text-3xl font-bold text-green-500 transition-all duration-300">60</div>
            </div>
        </div>
        <div id="current-word-container" class="mb-3 p-2 bg-slate-200 rounded-lg shadow-inner h-[52px] flex items-center justify-center">
            <div id="current-word-letters" class="flex-grow flex items-center justify-center space-x-1"></div>
        </div>
        <div id="grid-container" class="relative">
            <canvas id="line-canvas"></canvas>
            <div id="grid" class="grid grid-cols-4 gap-2 select-none"></div>
        </div>
    </div>
    
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 p-4">
        <div id="modal-content" class="w-full max-w-sm mx-auto"></div>
    </div>
    <div id="end-game-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div id="end-game-modal-content" class="w-full max-w-sm mx-auto"></div>
    </div>
    <div id="leaderboard-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div id="leaderboard-modal-content" class="w-full max-w-xs mx-auto"></div>
    </div>
    <div id="stats-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[70] p-4 overflow-y-auto">
        <div id="stats-modal-content" class="w-full max-w-xs mx-auto"></div>
    </div>
</div>

<script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, doc, getDoc, setDoc, updateDoc, increment, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // --- Config ---
    const [GRID_SIZE, GRID_COLS, GAME_TIME] = [16, 4, 60];
    const letterConfig={'A':{p:1},'B':{p:3},'C':{p:3},'D':{p:2},'E':{p:1},'F':{p:4},'G':{p:2},'H':{p:4},'I':{p:1},'J':{p:8},'K':{p:5},'L':{p:1},'M':{p:3},'N':{p:1},'O':{p:1},'P':{p:3},'Q':{p:10},'R':{p:1},'S':{p:1},'T':{p:1},'U':{p:1},'V':{p:4},'W':{p:4},'X':{p:8},'Y':{p:4},'Z':{p:10}};
    const VOWELS = ['A', 'E', 'I', 'O', 'U'];
    const HARD_CONSONANTS = ['J', 'K', 'Q', 'X', 'Z'];
    const LETTER_BAG_STRING = "EEEEEEEEEEEEAAAAAAAAAARRRRRRRRRRIIIIIIIIIOOOOOOOOTTTTTTTTNNNNNNNNSSSSSSSLLLLLLUUUUDDDDGGGBBCCMMPPFFHHVVWWYYKJXQZ";

    // --- DOM Elements ---
    const gameContainer = document.getElementById('game-container');
    const gameContentEl = document.getElementById('game-content');
    const gridContainer = document.getElementById('grid-container');
    const grid = document.getElementById('grid'), lineCanvas = document.getElementById('line-canvas'), ctx = lineCanvas.getContext('2d');
    const scoreEl = document.getElementById('score'), timerEl = document.getElementById('timer');
    const topLeftDisplayEl = document.getElementById('top-left-display');
    const menuContainer = document.getElementById('menu-container');
    const menuButton = document.getElementById('menu-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const currentWordLettersEl = document.getElementById('current-word-letters');
    const messageModal = document.getElementById('message-modal'), modalContent = document.getElementById('modal-content');
    const endGameModal = document.getElementById('end-game-modal'), endGameModalContent = document.getElementById('end-game-modal-content');
    const leaderboardModal = document.getElementById('leaderboard-modal'), leaderboardModalContent = document.getElementById('leaderboard-modal-content');
    const statsModal = document.getElementById('stats-modal'), statsModalContent = document.getElementById('stats-modal-content');

    // --- Firebase State ---
    let auth, db, userId;

    // --- Game State ---
    let score = 0, timer = GAME_TIME, timerInterval, dictionaryTrie, foundWords = [], selectedTiles = [], isMouseDown = false;
    let tilePositions = [];
    let isPracticeMode = false; 
    let practiceTimeElapsed = 0;
    let animationInterval;

    // --- Trie Data Structure ---
    class Trie {
        constructor(data = null) {
            this.root = data || {}; 
        }
        search(word, isPrefix = false) {
            let node = this.root;
            for (const char of word) {
                if (!node[char]) return false;
                node = node[char];
            }
            return isPrefix ? true : node.isEndOfWord === true;
        }
    }
// Checks if the daily leaderboard needs to be reset
async function checkAndResetDailyLeaderboard() {
    if (!db) return;
    const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
    const leaderboardRef = doc(db, "leaderboards", "daily");

    try {
        const docSnap = await getDoc(leaderboardRef);
        if (!docSnap.exists() || docSnap.data().lastReset !== todayStr) {
            console.log(`Resetting daily leaderboard for ${todayStr}...`);
            await setDoc(leaderboardRef, {
                lastReset: todayStr,
                topScores: []
            });
        }
    } catch (e) {
        console.error("Could not check or reset daily leaderboard:", e);
    }
}
    // --- Init ---
    function main() {
        setupEventListeners();
        topLeftDisplayEl.innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider">High</div><div id="high-score" class="text-3xl font-black text-slate-400">0</div>`;
        showWelcomeScreen();
        loadAssets(); 
    }
    
    async function loadAssets() {
        const playGameModeButton = document.getElementById('play-game-mode-button');
        const playPracticeButton = document.getElementById('play-practice-button');
        const loadingErrorEl = document.getElementById('loading-error');
        const globalPlayCountSpan = document.getElementById('global-play-count');

        // --- Task 1: Initialize Firebase and fetch user data (runs in the background) ---
        const initializeFirebase = async () => {
            try {
                const firebaseConfig = { apiKey: "AIzaSyBa2DPRjwaI-G5mz-OmHVXEDJ4_MzBAZgA", authDomain: "word-rush-game-9010a.firebaseapp.com", projectId: "word-rush-game-9010a", storageBucket: "word-rush-game-9010a.appspot.com", messagingSenderId: "551838491871", appId: "1:551838491871:web:757325be04daab9289b56a" };
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase connected. User ID:", userId);
                        await checkAndResetDailyLeaderboard(); // Reset leaderboard if needed
                        fetchGlobalStats();
                        fetchPlayerStats(userId);
                        document.getElementById('show-leaderboard-button').disabled = false;
                    } else {
                        signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                    }
                });
            } catch (firebaseError) {
                console.warn("Firebase features failed to load, continuing in offline mode:", firebaseError);
                if (globalPlayCountSpan) globalPlayCountSpan.textContent = "N/A";
            }
        };
        
        // --- Task 2: Load the dictionary (and enable buttons on success) ---
        // This is the "blocking" task for gameplay readiness.
        const loadDictionaryAndEnableButtons = async () => {
            // Set initial loading state for buttons
            if (playGameModeButton) {
                playGameModeButton.disabled = true;
                playGameModeButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Loading...</span></div>`;
            }
            if (playPracticeButton) {
                playPracticeButton.disabled = true;
                playPracticeButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Loading...</span></div>`;
            }
            
            try {
                const res = await fetch('https://raw.githubusercontent.com/tputerio/word-rush-game/main/dictionary.json');
                if (!res.ok) throw new Error(`Dictionary download failed: ${res.statusText}`);
                const trieData = await res.json();
                dictionaryTrie = new Trie(trieData);
                console.log("Pre-built dictionary loaded. Game is playable.");
                // Enable buttons now that dictionary is ready
                if (playGameModeButton) {
                    playGameModeButton.disabled = false;
                    playGameModeButton.innerHTML = `<div class="flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-6 h-6 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 0 0 6.16-12.12A14.98 14.98 0 0 0 9.631 8.41m5.96 5.96a14.926 14.926 0 0 1-5.841 2.58m-.119-8.54a6 6 0 0 0-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 0 0-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 0 1-2.448-2.448 14.9 14.9 0 0 1 .06-.312m-2.24 2.39a4.493 4.493 0 0 0-1.757 4.306 4.493 4.493 0 0 0 4.306-1.758M16.5 9a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" /></svg><span>Play</span></div>`;
                }
                if (playPracticeButton) {
                    playPracticeButton.disabled = false;
                    playPracticeButton.innerHTML = `<div class="flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-6 h-6 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" /></svg><span>Practice</span></div>`;
                }
            } catch (e) {
                console.error("Critical Asset loading failed (Dictionary):", e);
                if (loadingErrorEl) loadingErrorEl.textContent = "Error: Could not load game dictionary.";
                if (playGameModeButton) { playGameModeButton.innerHTML = `<span>Error</span>`; playGameModeButton.classList.add('bg-red-500'); }
                if (playPracticeButton) { playPracticeButton.innerHTML = `<span>Error</span>`; playPracticeButton.classList.add('bg-red-500'); }
            }
        };

        // --- Start both tasks in parallel ---
        initializeFirebase();
        loadDictionaryAndEnableButtons();
    }

    async function fetchGlobalStats() {
        const globalPlayCountSpan = document.getElementById('global-play-count');
        if (!db || !globalPlayCountSpan) return;
        try {
            const statsRef = doc(db, "gameStats", "stats");
            const docSnap = await getDoc(statsRef);
            if (docSnap.exists()) {
                globalPlayCountSpan.textContent = docSnap.data().playCount.toLocaleString();
            } else {
                globalPlayCountSpan.textContent = "0";
            }
        } catch(e) {
            console.warn("Could not fetch global stats:", e);
            if (globalPlayCountSpan) globalPlayCountSpan.textContent = "N/A";
        }
    }

    async function fetchPlayerStats(uid) {
        if (!db) return;
        const playerDocRef = doc(db, "players", uid);
        try {
            const docSnap = await getDoc(playerDocRef);
            let highScore = 0;
            let gamesPlayed = 0;
            let playerName = 'Anonymous';

            if (docSnap.exists()) {
                const playerData = docSnap.data();
                highScore = playerData.highScore || 0;
                gamesPlayed = playerData.totalGamesPlayed || 0;
                playerName = playerData.name && playerData.name !== 'Anonymous' ? playerData.name : 'Anonymous';
            }

            const highScoreEl = document.getElementById('high-score');
            if (highScoreEl) highScoreEl.textContent = highScore;

            const welcomeHighScoreEl = document.getElementById('welcome-high-score');
            if (welcomeHighScoreEl) welcomeHighScoreEl.textContent = highScore;
            
            const playerStatsDisplayEl = document.getElementById('player-stats-display');
            if (playerStatsDisplayEl) {
                playerStatsDisplayEl.innerHTML = `Playing as <strong class="text-slate-500">${playerName}</strong> | You’ve played <strong class="text-slate-500">${gamesPlayed}</strong> games!`;
            }

        } catch (e) {
            console.error("Could not fetch player stats:", e);
        }
    }
    
    function createGrid() {
        const board = generateAndValidateBoard();
        grid.innerHTML = '';
        for (let i = 0; i < GRID_SIZE; i++) {
            const letter = board[i];
            const points = letterConfig[letter].p;
            const tile = document.createElement('div');
            tile.className = 'tile w-full aspect-square border-2 border-slate-300 bg-white rounded-lg flex items-center justify-center text-3xl font-bold text-slate-800 cursor-pointer';
            tile.dataset.letter = letter; tile.dataset.points = points; tile.dataset.id = i;
            tile.innerHTML = `<span>${letter}<sub class="text-xs font-semibold ml-1">${points}</sub></span>`;
            const bonusType = getBonusType();
            if (bonusType) {
                tile.dataset.bonus = bonusType.type;
                tile.classList.add(bonusType.class);
                tile.innerHTML += `<div class="bonus-label">${bonusType.label}</div>`;
            }
            grid.appendChild(tile);
        }
        setTimeout(resizeCanvas, 0);
    }
    
    function getRandomLetter() { return LETTER_BAG_STRING[Math.floor(Math.random() * LETTER_BAG_STRING.length)]; }
    function getBonusType() {
        const rand = Math.random();
        if (rand < 0.08) return { type: 'Time', label: '+5s', class: 'bonus-Time' };
        if (rand < 0.18) return { type: 'DW', label: 'DW', class: 'bonus-DW' };
        if (rand < 0.28) return { type: 'TL', label: 'TL', class: 'bonus-TL' };
        if (rand < 0.40) return { type: 'DL', label: 'DL', class: 'bonus-DL' };
        return null;
    }

    function startGame(practiceMode = false) {
        isPracticeMode = practiceMode; 
        clearInterval(timerInterval); 
        score = 0; 
        foundWords = []; 
        updateScoreDisplay(); 
        
        gameContainer.appendChild(menuContainer);
        menuContainer.className = 'absolute top-4 right-4 z-30';
        document.getElementById('menu-home').style.display = 'flex';
        menuContainer.classList.remove('hidden');

        if (isPracticeMode) {
            practiceTimeElapsed = 0;
            topLeftDisplayEl.innerHTML = `<div class="text-xs font-bold text-blue-500 uppercase tracking-wider">Pace</div><div id="pace-score" class="text-3xl font-black text-blue-400">0</div>`;
            updatePracticeUI(); 
            timerInterval = setInterval(() => {
                practiceTimeElapsed++;
                updatePracticeUI();
            }, 1000);
        } else {
            const highScoreEl = document.getElementById('high-score');
            const currentHighScore = highScoreEl ? highScoreEl.textContent : '0';
            topLeftDisplayEl.innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider">High</div><div id="high-score" class="text-3xl font-black text-slate-400">${currentHighScore}</div>`;
            timer = GAME_TIME; 
            updateTimerUI(); 
            if (db) { const statsRef = doc(db, "gameStats", "stats"); updateDoc(statsRef, { playCount: increment(1) }).catch(console.warn); }
            timerInterval = setInterval(() => { timer--; updateTimerUI(); if (timer <= 0) endGame(); }, 1000);
        }

        gameContentEl.classList.remove('blurred');
        messageModal.classList.add('hidden');
        clearInterval(animationInterval); // Fix for memory leak
        createGrid();
        grid.style.pointerEvents = 'auto'; 
    }
    
  function endGame() {
    clearInterval(timerInterval);
    grid.style.pointerEvents = 'none';
    menuContainer.classList.add('hidden');

    setTimeout(() => { 
        if (!isPracticeMode) { 
            saveGameHistoryAndStats(score);
        } else {
            resetGame();
        }
    }, 600);
}

    function resetGame() {
        clearInterval(timerInterval);
        endGameModal.classList.add('hidden');
        statsModal.classList.add('hidden');
        score = 0;
        foundWords = [];
        updateScoreDisplay();

        const highScoreEl = document.getElementById('high-score');
        const currentHighScore = highScoreEl ? highScoreEl.textContent : '0';

        topLeftDisplayEl.innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider">High</div><div id="high-score" class="text-3xl font-black text-slate-400">${currentHighScore}</div>`;
        showWelcomeScreen();
        loadAssets();
    }
    
    function handleInteraction(tile) {
        if (!tile || !isMouseDown) return;
        const lastSelected = selectedTiles[selectedTiles.length - 1];
        if (selectedTiles.length > 1 && tile === selectedTiles[selectedTiles.length - 2]) {
            const lastTile = selectedTiles.pop();
            lastTile.classList.remove('selected');
        } else if (!selectedTiles.includes(tile) && (!lastSelected || isAdjacent(tile, lastSelected))) {
            selectedTiles.push(tile);
            tile.classList.add('selected');
        }
        updateCurrentWord();
        drawLines();
    }
    
    function isAdjacent(t1, t2) {
        if (!t1 || !t2) return false;
        const id1 = parseInt(t1.dataset.id), id2 = parseInt(t2.dataset.id);
        const [c1, r1] = [id1 % GRID_COLS, Math.floor(id1 / GRID_COLS)];
        const [c2, r2] = [id2 % GRID_COLS, Math.floor(id2 / GRID_COLS)];
        return Math.abs(c1 - c2) <= 1 && Math.abs(r1 - r2) <= 1;
    }

    function submitWord() {
        const word = selectedTiles.map(t => t.dataset.letter).join('');
        if (word.length >= 3 && dictionaryTrie.search(word)) {
            let baseScore = 0; let wordMultiplier = 1; let timeBonus = 0;
            selectedTiles.forEach(tile => {
                let letterScore = parseInt(tile.dataset.points);
                switch(tile.dataset.bonus) {
                    case 'DL': letterScore *= 2; break; case 'TL': letterScore *= 3; break;
                    case 'DW': wordMultiplier *= 2; break; case 'Time': timeBonus += 5; break;
                }
                baseScore += letterScore;
            });
            let finalScore = baseScore * wordMultiplier;
            if (word.length >= 7) finalScore += 20;
            else if (word.length === 6) finalScore += 10;
            else if (word.length === 5) finalScore += 5;
            else if (word.length === 4) finalScore += 2;
            if (timeBonus > 0 && !isPracticeMode) {
                timer += timeBonus; 
                updateTimerUI();
            }
            foundWords.push({ word, score: finalScore, length: word.length });
            createFlyingScore(finalScore, selectedTiles[0]);
            triggerConfetti(selectedTiles);
            setTimeout(() => { score += finalScore; updateScoreDisplay(); }, 500);
            replaceSelectedTiles();
        }
        clearSelection();
    }

    function replaceSelectedTiles() {
        let currentBoardLetters = Array.from(grid.children).map(t => t.dataset.letter);
        selectedTiles.forEach(tile => { const index = parseInt(tile.dataset.id); currentBoardLetters[index] = null; });
        const newBoard = generateAndValidateBoard(currentBoardLetters);
        selectedTiles.forEach((tile) => {
            const index = parseInt(tile.dataset.id); const letter = newBoard[index]; const points = letterConfig[letter].p;
            tile.dataset.letter = letter; tile.dataset.points = points; tile.style.transform = 'scale(0)'; tile.dataset.bonus = '';
            tile.classList.remove('bonus-DL', 'bonus-TL', 'bonus-DW', 'bonus-Time');
            setTimeout(() => {
                tile.innerHTML = `<span>${letter}<sub class="text-xs font-semibold ml-1">${points}</sub></span>`;
                const bonusType = getBonusType();
                if (bonusType) { tile.dataset.bonus = bonusType.type; tile.classList.add(bonusType.class); tile.innerHTML += `<div class="bonus-label">${bonusType.label}</div>`; }
                tile.style.transform = 'scale(1)';
            }, 200);
        });
    }
    
    function clearSelection() { selectedTiles.forEach(t => t.classList.remove('selected')); selectedTiles = []; updateCurrentWord(); drawLines(); }
    
    async function saveGameHistoryAndStats(finalScore) {
    if (!db || !userId || isPracticeMode) {
        if (!isPracticeMode) showEndGameScreen();
        return;
    }

    const playerDocRef = doc(db, "players", userId);
    const gameData = { score: finalScore, timestamp: serverTimestamp(), words: foundWords.map(w => ({ word: w.word, score: w.score, length: w.length })) };
    
    try {
        await addDoc(collection(db, `players/${userId}/games`), gameData);
        
        await runTransaction(db, async (transaction) => {
            const playerDoc = await transaction.get(playerDocRef);
            const oldData = playerDoc.exists() ? playerDoc.data() : {};
            
            const newHighScore = Math.max(finalScore, oldData.highScore || 0);
            
            const currentBestWord = oldData.bestWord || { score: 0, word: ''};
            const gameBestWord = foundWords.length > 0 ? foundWords.reduce((best, current) => current.score > best.score ? current : best, { score: 0 }) : { score: 0, word: ''};
            const newBestWord = gameBestWord.score > currentBestWord.score ? { word: gameBestWord.word, score: gameBestWord.score } : currentBestWord;

            const updateData = {
                totalGamesPlayed: increment(1),
                totalPoints: increment(finalScore),
                lastPlayed: serverTimestamp(),
                highScore: newHighScore,
                bestWord: newBestWord
            };
            
            if (playerDoc.exists()) {
                transaction.update(playerDocRef, updateData);
            } else {
                // This is a new player, set their name and hasSubmittedName flag
                updateData.name = localStorage.getItem('wordRushPlayerName') || 'Anonymous';
                updateData.hasSubmittedName = false; // <-- Add this line
                transaction.set(playerDocRef, updateData);
            }
        });
        
        showEndGameScreen();

    } catch (e) {
        console.error("Error saving game history:", e);
        showEndGameScreen();
    }
}

async function submitLeaderboardScore(name, scoreToSave) {
    if (!name || scoreToSave === 0 || !db || !userId || isPracticeMode) return;
    localStorage.setItem('wordRushPlayerName', name);

    // Update player's name in profile
    await setDoc(doc(db, "players", userId), { name: name, hasSubmittedName: true }, { merge: true });

    // --- DAILY LEADERBOARD UPDATE ---
    const leaderboardRef = doc(db, "leaderboards", "daily");
    try {
        await runTransaction(db, async (transaction) => {
            const leaderboardDoc = await transaction.get(leaderboardRef);

            if (!leaderboardDoc.exists()) {
                console.error("Daily leaderboard document does not exist!");
                return;
            }

            const currentScores = leaderboardDoc.data().topScores || [];
            const oldEntry = currentScores.find(s => s.userId === userId);

            const newDailyHighScore = Math.max(oldEntry?.dailyHighScore || 0, scoreToSave);
            const newDailyTotalScore = (oldEntry?.dailyTotalScore || 0) + scoreToSave;
            const gameBestWord = foundWords.length > 0
                ? foundWords.reduce((best, current) => current.score > best.score ? current : best, { score: 0, word: '' })
                : { score: 0, word: '' };
            const newDailyBestWord = (gameBestWord.score > (oldEntry?.dailyBestWord?.score || 0))
                ? gameBestWord
                : oldEntry?.dailyBestWord || gameBestWord;

            const updatedEntry = {
                userId,
                name,
                dailyHighScore: newDailyHighScore,
                dailyTotalScore: newDailyTotalScore,
                dailyBestWord: newDailyBestWord
            };

            // Remove any previous score from the same user and add the new one
            const scoresWithoutUser = currentScores.filter(s => s.userId !== userId);
            const potentialNewScores = [...scoresWithoutUser, updatedEntry];

            // Sort the list by high score and keep only the top 10
            potentialNewScores.sort((a, b) => b.dailyHighScore - a.dailyHighScore);
            const newTopScores = potentialNewScores.slice(0, 10);

            transaction.update(leaderboardRef, { topScores: newTopScores });
        });
        console.log("Daily leaderboard updated successfully.");
    } catch (e) {
        console.error("Failed to update daily leaderboard:", e);
    }

    // --- ALL-TIME LEADERBOARD UPDATE ---
    const allTimeRef = doc(db, "leaderboards", "allTime");
    try {
        await runTransaction(db, async (transaction) => {
            const allTimeDoc = await transaction.get(allTimeRef);
            let data = allTimeDoc.exists() ? allTimeDoc.data() : {
                topByHighScore: [],
                topByTotalPoints: [],
                topByBestWord: []
            };

            // Find previous entries (if any)
            let prevHighScore = 0, prevTotalPoints = 0, prevBestWord = { word: '', score: 0 };
            let entryHigh = data.topByHighScore.find(u => u.userID === userId);
            let entryTotal = data.topByTotalPoints.find(u => u.userID === userId);
            let entryBest = data.topByBestWord.find(u => u.userID === userId);

            if (entryHigh) prevHighScore = entryHigh.score || 0;
            if (entryTotal) prevTotalPoints = entryTotal.totalPoints || 0;
            if (entryBest) prevBestWord = entryBest.bestWord || { word: '', score: 0 };

            // Calculate this game's best word
            const gameBestWord = foundWords.length > 0
                ? foundWords.reduce((best, current) => current.score > best.score ? current : best, { score: 0, word: '' })
                : { score: 0, word: '' };
            const newBestWord = (gameBestWord.score > (prevBestWord?.score || 0)) ? gameBestWord : prevBestWord;

            // Prepare new values
            const newHighScore = Math.max(prevHighScore, scoreToSave);
            const newTotalPoints = prevTotalPoints + scoreToSave;

            // Remove old entries
            data.topByHighScore = data.topByHighScore.filter(u => u.userID !== userId);
            data.topByTotalPoints = data.topByTotalPoints.filter(u => u.userID !== userId);
            data.topByBestWord = data.topByBestWord.filter(u => u.userID !== userId);

            // Add updated entries
            data.topByHighScore.push({
                userID: userId,
                name: name,
                score: newHighScore
            });
            data.topByTotalPoints.push({
                userID: userId,
                name: name,
                totalPoints: newTotalPoints
            });
            data.topByBestWord.push({
                userID: userId,
                name: name,
                bestWord: {
                    word: newBestWord.word,
                    score: newBestWord.score
                }
            });

            // Sort and keep top 10 for each category
            data.topByHighScore.sort((a, b) => b.score - a.score);
            data.topByHighScore = data.topByHighScore.slice(0, 10);

            data.topByTotalPoints.sort((a, b) => b.totalPoints - a.totalPoints);
            data.topByTotalPoints = data.topByTotalPoints.slice(0, 10);

            data.topByBestWord.sort((a, b) => (b.bestWord?.score || 0) - (a.bestWord?.score || 0));
            data.topByBestWord = data.topByBestWord.slice(0, 10);

            transaction.set(allTimeRef, data, { merge: true });
        });
        console.log("All-Time leaderboard updated successfully.");
    } catch (e) {
        console.error("Failed to update all-time leaderboard:", e);
    }
}
    
    function updateScoreDisplay() {
        scoreEl.textContent = score;
        scoreEl.classList.add('animate-pulse');
        scoreEl.addEventListener('animationend', () => scoreEl.classList.remove('animate-pulse'), { once: true });
        if (!isPracticeMode) {
            const highScoreEl = document.getElementById('high-score');
            const currentHighScore = parseInt(highScoreEl.textContent) || 0;
            if (score > currentHighScore) { 
                highScoreEl.textContent = score; 
                highScoreEl.classList.add('text-yellow-500', 'animate-pulse');
            }
        } else {
            updatePracticeUI();
        }
    }

    function updateTimerUI() {
        timerEl.textContent = timer;
        timerEl.classList.remove('text-green-500', 'text-yellow-500', 'text-red-500', 'animate-pulse');
        if (timer <= 10) { timerEl.classList.add('text-red-500', 'animate-pulse'); } 
        else if (timer <= 30) { timerEl.classList.add('text-yellow-500'); } 
        else { timerEl.classList.add('text-green-500'); }
    }
    
    function updatePracticeUI() {
        const minutes = Math.floor(practiceTimeElapsed / 60);
        const seconds = practiceTimeElapsed % 60;
        timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        timerEl.classList.remove('text-yellow-500', 'text-red-500', 'animate-pulse');
        timerEl.classList.add('text-green-500');
        
        const pace = Math.round((score / Math.max(1, practiceTimeElapsed)) * 60);
        const paceScoreEl = document.getElementById('pace-score');
        if (paceScoreEl) {
            paceScoreEl.textContent = isNaN(pace) ? 0 : pace;
        }
    }

    function triggerConfetti(tiles) { tiles.forEach(tile => { const rect = tile.getBoundingClientRect(); for (let i = 0; i < 10; i++) { const p = document.createElement('div'); p.className = 'particle'; const angle = Math.random() * Math.PI * 2, dist = Math.random() * 40 + 20; p.style.setProperty('--transform-end',`translate(${Math.cos(angle)*dist}px,${Math.sin(angle)*dist}px)`); p.style.left = `${rect.left+rect.width/2-4}px`; p.style.top = `${rect.top+rect.height/2-4}px`; document.body.appendChild(p); setTimeout(() => p.remove(), 1200); } }); }
    function triggerEndGameConfetti() {
        const modalContent = document.getElementById('end-game-modal-content');
        if (!modalContent) return;
        const rect = modalContent.getBoundingClientRect();
        const originX = rect.left + rect.width / 2;
        const originY = rect.top + 40;

        for (let i = 0; i < 60; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.random() * 120 + 50; 
            p.style.setProperty('--transform-end', `translate(${Math.cos(angle) * dist}px, ${Math.sin(angle) * dist}px)`);
            p.style.left = `${originX - 4}px`;
            p.style.top = `${originY - 4}px`;
            const colors = ['#facc15', '#f59e0b', '#60a5fa', '#3b82f6', '#22c55e'];
            p.style.background = colors[Math.floor(Math.random() * colors.length)];
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1200);
        }
    }
function createFlyingScore(points, startTile) {
    const el = document.createElement('div');
    el.className = 'flying-score';
    el.style.animation = 'none';
    el.style.position = 'absolute';
    el.textContent = `+${points}`;
    const rect = startTile.getBoundingClientRect();
    el.style.left = `${rect.left}px`;
    el.style.top = `${rect.top}px`;
    document.body.appendChild(el);

    // This is the updated part for smoother animation
    requestAnimationFrame(() => {
        requestAnimationFrame(() => { // Double request for browser compatibility
             el.style.animation = 'fly-to-score 1.5s ease-in-out forwards';
        });
    });

    setTimeout(() => el.remove(), 1500);
}     

function updateCurrentWord() { currentWordLettersEl.innerHTML = selectedTiles.map(t => `<span class="current-letter bg-white text-blue-500 font-bold text-xl p-1 rounded-md shadow-sm">${t.dataset.letter}</span>`).join(''); }

    function showWelcomeScreen() {
        modalContent.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl p-6 text-center modal-enter">
                <h1 class="text-4xl font-black text-slate-800 tracking-tighter mb-1 flex items-center justify-center">
                    <img src="https://raw.githubusercontent.com/tputerio/word-rush-game/main/word-worm-logo.png" alt="Word Worm Logo" class="w-12 h-12 mr-2">
                    <span>Word Worm</span>
                </h1>
                <p class="text-slate-500 text-sm mb-4">The fast-paced word finding game!</p>
                <div id="how-to-play-container" class="relative bg-slate-100 p-3 rounded-lg mb-4 h-[17rem] overflow-hidden"></div>
                <div class="flex flex-col sm:flex-row sm:space-x-4 mb-3">
                    <button id="play-practice-button" class="bg-blue-500 hover:bg-blue-600 flex-1 text-white font-bold py-2 px-4 rounded-lg text-base shadow-lg transition-transform hover:scale-105 mb-3 sm:mb-0 disabled:bg-slate-400 disabled:cursor-wait">...</button>
                    <button id="play-game-mode-button" class="bg-green-500 hover:bg-green-600 flex-1 text-white font-bold py-2 px-4 rounded-lg text-base shadow-lg transition-transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-wait">...</button>
                </div>
                <div class="flex justify-between items-center border-t border-slate-200 pt-3">
                    <div class="font-bold text-slate-600 text-base flex items-center">
                        <span class="inline-block w-6 h-6 mr-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0" /></svg></span>Your High: <span id="welcome-high-score">0</span>
                    </div>
                    <button id="show-leaderboard-button" class="font-bold text-green-500 hover:text-green-600 text-base flex items-center" disabled>
                        Leaderboard <span class="inline-block w-6 h-6 ml-1"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m6.115 5.19.319 1.913A6 6 0 0 0 8.11 10.36L9.75 12l-.387.775c-.217.433-.132.956.21 1.298l1.348 1.348c.21.21.329.497.329.795v1.089c0 .426.24.815.622 1.006l.153.076c.433.217.956.132 1.298-.21l.723-.723a8.7 8.7 0 0 0 2.288-4.042 1.087 1.087 0 0 0-.358-1.099l-1.33-1.108c-.251-.21-.582-.299-.905-.245l-1.17.195a1.125 1.125 0 0 1-.98-.314l-.295-.295a1.125 1.125 0 0 1 0-1.591l.13-.132a1.125 1.125 0 0 1 1.3-.21l.603.302a.809.809 0 0 0 1.086-1.086L14.25 7.5l1.256-.837a4.5 4.5 0 0 0 1.528-1.732l.146-.292M6.115 5.19A9 9 0 1 0 17.18 4.64M6.115 5.19A8.965 8.965 0 0 1 12 3c1.929 0 3.716.607 5.18 1.64" /></svg></span>
                    </button>
                </div>
                <p id="player-stats-display" class="text-xs text-slate-400 mt-3"></p>
                <p class="text-xs text-slate-400 mt-1"><span id="global-play-count">...</span> games played globally</p>
                <p id="loading-error" class="text-red-500 mt-2 font-semibold"></p>
            </div>
        `;
        gameContentEl.classList.remove('blurred');
        messageModal.classList.remove('hidden');
        setupTutorial();

        menuContainer.classList.add('hidden');
        
        document.getElementById('play-game-mode-button').onclick = () => startGame(false);
        document.getElementById('play-practice-button').onclick = () => startGame(true);
        const showLeaderboardButton = document.getElementById('show-leaderboard-button');
        if(showLeaderboardButton) showLeaderboardButton.onclick = showLeaderboardModal;
    }

    async function showLeaderboardModal() {
        leaderboardModal.classList.remove('hidden');
        gameContentEl.classList.add('blurred');
        leaderboardModalContent.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl p-6 text-center w-full max-w-xs mx-auto modal-enter">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center justify-center">Leaderboard <span class="inline-block w-6 h-6 ml-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m6.115 5.19.319 1.913A6 6 0 0 0 8.11 10.36L9.75 12l-.387.775c-.217.433-.132.956.21 1.298l1.348 1.348c.21.21.329.497.329.795v1.089c0 .426.24.815.622 1.006l.153.076c.433.217.956.132 1.298-.21l.723-.723a8.7 8.7 0 0 0 2.288-4.042 1.087 1.087 0 0 0-.358-1.099l-1.33-1.108c-.251-.21-.582-.299-.905-.245l-1.17.195a1.125 1.125 0 0 1-.98-.314l-.295-.295a1.125 1.125 0 0 1 0-1.591l.13-.132a1.125 1.125 0 0 1 1.3-.21l.603.302a.809.809 0 0 0 1.086-1.086L14.25 7.5l1.256-.837a4.5 4.5 0 0 0 1.528-1.732l.146-.292M6.115 5.19A9 9 0 1 0 17.18 4.64M6.115 5.19A8.965 8.965 0 0 1 12 3c1.929 0 3.716.607 5.18 1.64" /></svg></span></h2>
            <div class="flex p-1 bg-slate-200 rounded-lg mb-4">
                <button id="daily-tab" class="tab-button flex-1 py-1 px-2 rounded-md font-semibold text-sm transition-colors duration-200">Daily</button>
                <button id="all-time-tab" class="tab-button flex-1 py-1 px-2 rounded-md font-semibold text-sm transition-colors duration-200">All-Time</button>
            </div>
            <div id="leaderboard-loading-secondary" class="text-slate-500 p-2">Fetching Scores...</div>
            <div id="leaderboard-scroll-container" class="relative max-h-[20rem] overflow-y-auto">
                <div id="leaderboard-list-simple" class="space-y-2 text-left"></div>
            </div>
            <button id="close-leaderboard-button" class="mt-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Close</button>
        </div>`;
        const dailyTab = document.getElementById('daily-tab');
        const allTimeTab = document.getElementById('all-time-tab');
        const listEl = document.getElementById('leaderboard-list-simple');
        const loadingEl = document.getElementById('leaderboard-loading-secondary');
        const displayTab = (type) => {
            if (!db) { listEl.innerHTML = `<p class="text-red-500 text-center p-4">Leaderboard is offline.</p>`; if (loadingEl) loadingEl.style.display = 'none'; return; }
            if(type === 'daily') { dailyTab.classList.add('active'); allTimeTab.classList.remove('active'); fetchAndDisplayLeaderboard('daily', listEl, loadingEl); } 
            else { allTimeTab.classList.add('active'); dailyTab.classList.remove('active'); fetchAndDisplayLeaderboard('all-time', listEl, loadingEl); }
        };
        dailyTab.onclick = () => displayTab('daily');
        allTimeTab.onclick = () => displayTab('all-time');
        displayTab('daily'); 
        document.getElementById('close-leaderboard-button').onclick = () => { leaderboardModal.classList.add('hidden'); gameContentEl.classList.remove('blurred'); };
    }

    async function showStatsModal() {
        statsModal.classList.remove('hidden');
        gameContentEl.classList.add('blurred');
        statsModalContent.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl p-6 text-center modal-enter">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Loading Your Stats...</h2>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-900 mx-auto"></div>
        </div>`;
        
        const stats = await fetchAndCalculateStats();

        let statsHTML;
        if (!stats) {
            statsHTML = `<div class="bg-white rounded-2xl shadow-2xl p-6 modal-enter">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-slate-800 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" /></svg><span class="ml-2">Your Stats</span></h2><button id="close-stats-button" class="text-3xl leading-none text-slate-500 hover:text-slate-800">&times;</button></div>
                <p class="text-slate-500 text-center py-8">Play a game to see your stats here!</p>
            </div>`;
        } else {
            statsHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 modal-enter">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-slate-800 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" /></svg><span class="ml-2">Your Stats</span></h2><button id="close-stats-button" class="text-3xl leading-none text-slate-500 hover:text-slate-800">&times;</button></div>
                    <div class="grid grid-cols-3 gap-4 text-center mb-6 bg-slate-100 p-3 rounded-lg">
                        <div><div class="text-xs font-bold text-slate-500 uppercase">Total Games</div><div class="text-2xl font-black text-slate-800">${stats.totalGamesPlayed}</div></div>
                        <div><div class="text-xs font-bold text-slate-500 uppercase">Total Words</div><div class="text-2xl font-black text-slate-800">${stats.totalWordsFound}</div></div>
                        <div><div class="text-xs font-bold text-slate-500 uppercase">Total Score</div><div class="text-2xl font-black text-slate-800">${stats.totalScore.toLocaleString()}</div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><h3 class="text-base font-bold text-slate-700 mb-2 border-b pb-1">Best Scores</h3><ol class="space-y-1 text-sm">${stats.top10Scores.map((s, i) => `<li class="flex justify-between p-1 ${i%2 === 0 ? 'bg-slate-50' : ''} rounded"><span><strong>${s.score}</strong></span><span class="text-slate-500">${s.date}</span></li>`).join('')}</ol></div>
                        <div><h3 class="text-base font-bold text-slate-700 mb-2 border-b pb-1">Longest Words</h3><ol class="space-y-1 text-sm">${stats.top10LongestWords.map((w, i) => `<li class="p-1 ${i%2 === 0 ? 'bg-slate-50' : ''} rounded"><strong>${w.word}</strong> (${w.length})</li>`).join('')}</ol></div>
                    </div>
                </div>`;
        }
        
        statsModalContent.innerHTML = statsHTML;
        document.getElementById('close-stats-button').onclick = () => { statsModal.classList.add('hidden'); gameContentEl.classList.remove('blurred'); };
    }

    async function fetchAndCalculateStats() {
        if (!db || !userId) return null;
        const gamesRef = collection(db, `players/${userId}/games`);
        const querySnapshot = await getDocs(query(gamesRef, orderBy('timestamp', 'desc')));
        if (querySnapshot.empty) return null;
        let totalScore = 0; let allWords = []; let allGames = [];
        querySnapshot.forEach(doc => {
            const game = doc.data(); totalScore += game.score; allWords.push(...(game.words || []));
            allGames.push({ score: game.score, date: game.timestamp ? game.timestamp.toDate().toLocaleDateString() : 'N/A' });
        });
        const top10Scores = allGames.sort((a, b) => b.score - a.score).slice(0, 10);
        const uniqueLongestWords = [...new Map(allWords.map(item => [item.word, item])).values()];
        const top10LongestWords = uniqueLongestWords.sort((a,b) => b.length - a.length).slice(0, 10);
        return { totalGamesPlayed: querySnapshot.size, totalWordsFound: allWords.length, totalScore, top10Scores, top10LongestWords };
    }
    
async function fetchAndDisplayLeaderboard(type, listElement, loadingElement) {
    if (!listElement) return;
    if (loadingElement) loadingElement.style.display = 'block';
    listElement.innerHTML = '';
    if (!db) {
        listElement.innerHTML = `<p class="text-red-500 text-center p-4">Leaderboard is offline.</p>`;
        if (loadingElement) loadingElement.style.display = 'none';
        return;
    }

    try {
        let html = '';

        if (type === 'all-time') {
            const leaderboardRef = doc(db, "leaderboards", "allTime");
            const docSnap = await getDoc(leaderboardRef);

            if (!docSnap.exists() || !docSnap.data()) {
                html = `<p class="text-slate-500 text-center text-sm p-2">All-Time leaderboard is not available.</p>`;
            } else {
                const data = docSnap.data();
                const categories = [
                    { key: 'topByHighScore',   title: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0" /></svg> High Score' },
                    { key: 'topByTotalPoints', title: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5m.75-9 3-3 2.148 2.148A12.061 12.061 0 0 1 16.5 7.605" /></svg> Total Points' },
                    { key: 'topByBestWord',    title: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg> Best Word' }
                ];

                for (const cat of categories) {
                    html += `<h3 class="text-lg font-bold text-slate-800 my-2 sticky top-0 bg-white py-1 flex items-center gap-2">${cat.title}</h3>`;
                    
                    const players = data[cat.key] || [];

                    if (players.length === 0) {
                        html += `<p class="text-slate-500 text-center text-sm p-2">No players in this category yet.</p>`;
                    } else {
                        const scores = players.map((player, i) => {
                            let value;
                            
                            if (cat.key === 'topByBestWord') {
                                value = player.bestWord && player.bestWord.word ? `${player.bestWord.word} (${player.bestWord.score})` : 'N/A';
                            } else if (cat.key === 'topByTotalPoints') {
                                value = player.totalPoints?.toLocaleString() || 0;
                            } else {
                                value = player.score?.toLocaleString() || 0;
                            }

                            return `<li class="flex items-center p-2 rounded-lg ${i % 2 === 0 ? 'bg-slate-50' : ''}"><span class="font-bold text-slate-500 w-8 text-center">${i + 1}.</span><span class="font-semibold text-slate-800 flex-grow truncate mr-4">${player.name}</span><span class="font-bold text-green-500">${value}</span></li>`;
                        }).join('');
                        html += `<ol class="space-y-1">${scores}</ol>`;
                    }
                }
            }
        } else { // This is the 'daily' logic
            const leaderboardRef = doc(db, "leaderboards", "daily");
            const docSnap = await getDoc(leaderboardRef);

            if (!docSnap.exists() || !docSnap.data().topScores || docSnap.data().topScores.length === 0) {
                html += `<p class="text-slate-500 text-center text-sm p-2">No scores yet today. Be the first!</p>`;
            } else {
                const dailyPlayers = docSnap.data().topScores;
                
                // --- THIS IS THE CORRECTED PART ---
                const categories = [
                    { key: 'dailyHighScore',  title: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0" /></svg> High Score' },
                    { key: 'dailyTotalScore', title: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5m.75-9 3-3 2.148 2.148A12.061 12.061 0 0 1 16.5 7.605" /></svg> Total Points' },
                    { key: 'dailyBestWord',   title: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg> Best Word' }
                ];
                // --- END OF CORRECTION ---

                for (const cat of categories) {
                    html += `<h3 class="text-lg font-bold text-slate-800 my-2 sticky top-0 bg-white py-1 flex items-center gap-2">${cat.title}</h3>`;
                    
                    const sortedPlayers = [...dailyPlayers].sort((a, b) => {
                        if (cat.key === 'dailyBestWord') {
                            return (b.dailyBestWord?.score || 0) - (a.dailyBestWord?.score || 0);
                        }
                        return (b[cat.key] || 0) - (a[cat.key] || 0);
                    });

                    const scores = sortedPlayers.map((player, i) => {
                        let value;
                        if (cat.key === 'dailyBestWord') {
                            value = player.dailyBestWord && player.dailyBestWord.word ? `${player.dailyBestWord.word} (${player.dailyBestWord.score})` : 'N/A';
                        } else {
                            value = player[cat.key]?.toLocaleString() || 0;
                        }
                        return `<li class="flex items-center p-2 rounded-lg ${i % 2 === 0 ? 'bg-slate-50' : ''}"><span class="font-bold text-slate-500 w-8 text-center">${i + 1}.</span><span class="font-semibold text-slate-800 flex-grow truncate mr-4">${player.name}</span><span class="font-bold text-green-500">${value}</span></li>`;
                    }).join('');
                    html += `<ol class="space-y-1">${scores}</ol>`;
                }
            }
        }
        listElement.innerHTML = html;
    } catch (e) {
        console.error(`Could not fetch ${type} leaderboard`, e);
        listElement.innerHTML = `<p class="text-red-500 text-center p-4">Could not load leaderboard.</p>`;
    } finally {
        if (loadingElement) loadingElement.style.display = 'none';
    }
}
    
    
    function setupEventListeners() {
        const getTileFromEvent = (e) => { const touch = e.touches ? e.touches[0] : e; const point = { x: touch.clientX, y: touch.clientY }; let closestTile = null; let minDistance = Infinity; tilePositions.forEach(tilePos => { const distance = Math.sqrt((point.x - tilePos.center.x)**2 + (point.y - tilePos.center.y)**2); if (distance < minDistance && distance < tilePos.hitRadius) { minDistance = distance; closestTile = tilePos.el; } }); return closestTile; };
        const startInteraction = e => { e.preventDefault(); isMouseDown = true; clearSelection(); const tile = getTileFromEvent(e); handleInteraction(tile); };
        const moveInteraction = e => { if (!isMouseDown) return; e.preventDefault(); const tile = getTileFromEvent(e); handleInteraction(tile); };
        const endInteraction = () => { if (!isMouseDown) return; submitWord(); isMouseDown = false; };
        grid.addEventListener('pointerdown', startInteraction); grid.addEventListener('pointermove', moveInteraction); grid.addEventListener('pointerup', endInteraction); grid.addEventListener('pointerleave', endInteraction); 
        window.addEventListener('resize', resizeCanvas);
        menuButton.addEventListener('click', (e) => { e.stopPropagation(); const isHidden = dropdownMenu.classList.contains('hidden'); if (isHidden) { dropdownMenu.classList.remove('hidden'); setTimeout(() => { dropdownMenu.style.opacity = '1'; dropdownMenu.style.transform = 'scale(1)'; }, 10); } else { dropdownMenu.style.opacity = '0'; dropdownMenu.style.transform = 'scale(0.95)'; setTimeout(() => dropdownMenu.classList.add('hidden'), 200); } });
        document.addEventListener('click', () => { if (!dropdownMenu.classList.contains('hidden')) { dropdownMenu.style.opacity = '0'; dropdownMenu.style.transform = 'scale(0.95)'; setTimeout(() => dropdownMenu.classList.add('hidden'), 200); } });
        document.getElementById('menu-home').addEventListener('click', (e) => { e.preventDefault(); resetGame(); });
        document.getElementById('menu-stats').addEventListener('click', (e) => { e.preventDefault(); showStatsModal(); });
        document.getElementById('menu-leaderboard').addEventListener('click', (e) => { e.preventDefault(); showLeaderboardModal(); });
    }
    
    function cacheTilePositions(){tilePositions=[];for(const t of grid.children){const e=t.getBoundingClientRect();tilePositions.push({el:t,center:{x:e.left+e.width/2,y:e.top+e.height/2},hitRadius:.4*t.offsetWidth})}}
    function resizeCanvas(){const t=grid.getBoundingClientRect();lineCanvas.width=t.width,lineCanvas.height=t.height,cacheTilePositions(),drawLines()}
    function drawLines(){if(clearLines(),!(selectedTiles.length<2)){ctx.beginPath(),ctx.strokeStyle="rgba(59, 130, 246, 0.8)",ctx.lineWidth=12,ctx.lineCap="round",ctx.lineJoin="round",selectedTiles.forEach((t,e)=>{const o=getTileCenter(t);0===e?ctx.moveTo(o.x,o.y):ctx.lineTo(o.x,o.y)}),ctx.stroke()}}
    function clearLines(){ctx.clearRect(0,0,lineCanvas.width,lineCanvas.height)}
    function getTileCenter(t){const e=grid.getBoundingClientRect(),o=t.getBoundingClientRect();return{x:o.left+o.width/2-e.left,y:o.top+o.height/2-e.top}}
    function checkNoClumps(board) {for(let r=0;r<=2;r++)for(let c=0;c<=2;c++){const t=r*GRID_COLS+c,e=t+1,o=t+GRID_COLS,l=o+1;const n=[board[t],board[e],board[o],board[l]];if(n.every(l=>VOWELS.includes(l))||n.every(l=>!VOWELS.includes(l)))return!1}return!0}
    function generateAndValidateBoard(t=null){let e;let o=0;for(let l=0;l<200;l++){if(o++,e=t?[...t]:new Array(GRID_SIZE).fill(null),e.forEach((t,o)=>{null===t&&(e[o]=getRandomLetter())}),dictionaryTrie&&isBoardPlayable(e))return e;if(!dictionaryTrie&&l>0)return e;e=null}return console.warn("Failed to generate a high-quality board after 200 attempts, using last random attempt."),e||Array.from({length:GRID_SIZE},()=>getRandomLetter())}
    function isBoardPlayable(t){if(t.filter(t=>VOWELS.includes(t)).length<3||t.filter(t=>VOWELS.includes(t)).length>7)return!1;if(t.filter(t=>HARD_CONSONANTS.includes(t)).length>1)return!1;const e=t.indexOf("Q");if(-1!==e&&!getNeighbors(e,t).some(t=>"U"===t))return!1;const o=solveBoard(t);return!(Array.from(o).filter(t=>t.length>=4).length<2||Array.from(o).filter(t=>3===t.length).length<2)&&checkNoClumps(t)}
    function getNeighbors(t,e){const o=[];const[l,n]=[t%GRID_COLS,Math.floor(t/GRID_COLS)];for(let s=-1;s<=1;s++)for(let a=-1;a<=1;a++){if(0===s&&0===a)continue;const[r,i]=[l+s,n+a];r>=0&&r<GRID_COLS&&i>=0&&i<GRID_COLS&&o.push(e[i*GRID_COLS+r])}return o}
    function solveBoard(t){const e=new Set;for(let o=0;o<GRID_SIZE;o++)findWordsRecursive(o,"",[o],e,t);return e}
    function findWordsRecursive(t,e,o,l,n){if(e+=n[t],!dictionaryTrie||!dictionaryTrie.search(e,!0))return;e.length>=3&&dictionaryTrie.search(e)&&l.add(e);const[s,a]=[t%GRID_COLS,Math.floor(t/GRID_COLS)];for(let r=-1;r<=1;r++)for(let i=-1;i<=1;i++){if(0===r&&0===i)continue;const[c,d]=[s+r,a+i];const h=d*GRID_COLS+c;c>=0&&c<GRID_COLS&&d>=0&&d<GRID_COLS&&!o.includes(h)&&findWordsRecursive(h,e,[...o,h],l,n)}}


    async function showEndGameScreen() {
        gameContentEl.classList.add('blurred');
        endGameModal.classList.remove('hidden');
        triggerEndGameConfetti();

        const sortedWords = [...foundWords].sort((a,b)=>b.score-a.score);
        const foundWordsHTML = sortedWords.length ? sortedWords.map(fw => `<div class="flex justify-between text-sm p-1 ${sortedWords.indexOf(fw) % 2 === 0 ? 'bg-slate-50' : ''} rounded"><span class="font-semibold">${fw.word.toUpperCase()}</span><span>+${fw.score}</span></div>`).join('') : '<p class="text-sm text-slate-500 text-center py-4">No words found.</p>';

        endGameModalContent.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl p-6 text-center w-full max-w-sm mx-auto modal-enter">
                <h2 class="text-3xl font-black text-green-500">Great Game!</h2>
                <p class="text-slate-600 mb-2">Your final score is:</p>
                <p class="text-6xl font-black text-slate-800 mb-4">${score}</p>
                <div id="submission-container" class="h-12 flex items-center justify-center"></div>
                <div class="text-left w-full mt-4">
                    <div class="flex justify-between items-baseline mb-2 border-b pb-2">
                        <h3 class="text-xl font-bold text-slate-700">Your Words (${foundWords.length})</h3>
                        <button id="endgame-stats-button" class="flex items-center text-base font-bold text-blue-500 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" /></svg><span class="ml-1">Your Stats</span></button>
                    </div>
                    <div class="space-y-1 max-h-48 overflow-y-auto pr-2">${foundWordsHTML}</div>
                </div>
                <div class="flex space-x-2 mt-6">
                    <button id="endgame-leaderboard-button" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-4 rounded-lg text-lg flex-1">Leaderboard</button>
                    <button id="play-again-button" class="bg-green-500 hover:bg-green-600 w-full text-white font-bold py-3 px-4 rounded-lg text-lg shadow-lg transition-transform hover:scale-105 flex-1">Play Again</button>
                </div>
            </div>`;
            
        document.getElementById('play-again-button').onclick = resetGame;
        document.getElementById('endgame-leaderboard-button').onclick = showLeaderboardModal;
        document.getElementById('endgame-stats-button').onclick = showStatsModal;

        const submissionContainer = document.getElementById('submission-container');
        submissionContainer.innerHTML = `<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-900"></div>`;

        let playerName = null;
        let showSubmitForm = true;

        if (db && userId) {
            const playerDoc = await getDoc(doc(db, "players", userId));
            if (playerDoc.exists() && playerDoc.data().name && playerDoc.data().name !== 'Anonymous') {
                playerName = playerDoc.data().name;
                showSubmitForm = false;
            }
        }
        
const processSubmission = async (name, currentScore) => {
    // Get the user's previous daily high score
    let previousDailyHigh = 0;
    if (db && userId) {
        const leaderboardRef = doc(db, "leaderboards", "daily");
        const leaderboardDoc = await getDoc(leaderboardRef);
        if (leaderboardDoc.exists()) {
            const topScores = leaderboardDoc.data().topScores || [];
            const entry = topScores.find(s => s.userId === userId);
            if (entry) previousDailyHigh = entry.dailyHighScore || 0;
        }
    }

    let message = `Score submitted as <strong>${name}</strong>!`;
    let didPlaceOnLeaderboard = false;

    // Only submit if it's their best score today
    if (currentScore > previousDailyHigh) {
        await submitLeaderboardScore(name, currentScore);

        // Fetch updated leaderboard to find their rank
        const leaderboardRef = doc(db, "leaderboards", "daily");
        const leaderboardDoc = await getDoc(leaderboardRef);
        let rank = null;
        if (leaderboardDoc.exists()) {
            const topScores = leaderboardDoc.data().topScores || [];
            // Sort by dailyHighScore descending
            const sorted = [...topScores].sort((a, b) => (b.dailyHighScore || 0) - (a.dailyHighScore || 0));
            // Find rank (1-based)
            rank = sorted.findIndex(entry => entry.userId === userId) + 1;
        }
        const leaderboardDisplayLimit = 10;
        if (rank && rank <= leaderboardDisplayLimit) {
            message = `You placed <strong>#${rank}</strong> on today's leaderboard!`;            
            didPlaceOnLeaderboard = true;
        }
    } else {
        // If not a new daily high, still submit for record-keeping
        await submitLeaderboardScore(name, currentScore);
    }

    submissionContainer.innerHTML = `<div class="flex items-center justify-center text-green-600 font-bold pop-in"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/></svg> ${message}</div>`;
};

        if (!showSubmitForm) {
            processSubmission(playerName, score);
        } else {
            submissionContainer.innerHTML = `<div id="submit-score-form" class="w-full"><div class="flex space-x-2"><input type="text" id="player-name" placeholder="Enter your name" class="w-full px-3 py-2 border border-slate-300 rounded-lg" maxlength="10"><button id="submit-global-score" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Submit</button></div></div>`;
            const nameInput = document.getElementById('player-name'); 
            nameInput.value = localStorage.getItem('wordRushPlayerName') || '';
            document.getElementById('submit-global-score').onclick = async (e) => { 
                const button = e.target; 
                button.disabled = true; button.textContent = '...'; 
                const newPlayerName = nameInput.value.trim(); 
                if (newPlayerName) { 
                    await processSubmission(newPlayerName, score);
                } else { 
                    button.disabled = false; button.textContent = 'Submit'; 
                } 
            };
        }
    }

    function setupTutorial() {
        const container = document.getElementById('how-to-play-container'); if (!container) return;
        container.innerHTML = `<div class="relative w-full h-full flex flex-col">
            <h3 class="text-md font-bold text-slate-700 text-center mb-2">How to Play</h3>
            <div id="tutorial-content" class="flex-grow overflow-y-auto pr-2">
                <div class="mb-4 flex flex-col justify-center items-center">
                    <div id="tutorial-word-builder" class="h-8 mb-2 w-32 bg-white rounded-md flex items-center justify-center space-x-0.5 shadow-inner"><span class="opacity-0">W</span></div>
                    <div id="tutorial-grid-container" class="relative w-32 h-32">
                        <canvas id="tutorial-line-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: 5;"></canvas>
                        <div class="grid grid-cols-4 gap-1">${['W','A','R','D','O','R','D','E','B','N','M','I','S','L','P','T'].map(l => `<div class="tutorial-tile w-8 h-8 flex items-center justify-center font-bold text-base bg-white rounded-md border-2 border-slate-300">${l}<sub class="text-[0.55rem] font-semibold ml-0.5">${letterConfig[l]?letterConfig[l].p:1}</sub></div>`).join('')}</div>
                    </div>
                    <p class="text-center text-xs font-semibold text-slate-700 mt-4">Touch and drag to form words (3+ letters)!</p>
                </div>
                <div class="text-left">
                    <ul class="text-xs space-y-2 mb-4">
                        <li class="flex items-start"><span class="inline-block w-5 h-5 mr-2 shrink-0"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0" /></svg></span><span><strong>Your Goal:</strong> Score as many points as you can in 60 seconds!</span></li>
                        <li class="flex items-start"><span class="inline-block w-5 h-5 mr-2 shrink-0"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 14.25v2.25m3-4.5v4.5m3-6.75v6.75m3-9v9M6 20.25h12A2.25 2.25 0 0 0 20.25 18V6A2.25 2.25 0 0 0 18 3.75H6A2.25 2.25 0 0 0 3.75 6v12A2.25 2.25 0 0 0 6 20.25Z" /></svg></span><span><strong>How to Score:</strong> Your score is the sum of letter points and any bonuses.</span></li>
                        <li class="flex items-start"><span class="inline-block w-5 h-5 mr-2 shrink-0"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" /></svg></span><span><strong>Pro-Tip:</strong> Use bonuses and long words to maximize your score!</span></li>
                    </ul>
                    <div class="text-xs space-y-2 mb-4">
                        <div><strong class="font-semibold text-slate-700">Bonus Tiles:</strong>
                            <div class="grid grid-cols-2 gap-x-4 mt-1">
                                <ul class="list-none space-y-1">
                                    <li class="flex items-center"><span><span class="inline-block text-white text-center font-bold rounded px-1.5 py-0.5 mr-2 w-8" style="background-color: #3b82f6;">DL</span> Double Letter</span></li>
                                    <li class="flex items-center"><span><span class="inline-block text-white text-center font-bold rounded px-1.5 py-0.5 mr-2 w-8" style="background-color: #ef4444;">TL</span> Triple Letter</span></li>
                                </ul>
                                <ul class="list-none space-y-1">
                                    <li class="flex items-center"><span><span class="inline-block text-white text-center font-bold rounded px-1.5 py-0.5 mr-2 w-8" style="background-color: #f59e0b;">DW</span> Double Word</span></li>
                                    <li class="flex items-center"><span><span class="inline-block text-white text-center font-bold rounded px-1.5 py-0.5 mr-2 w-8" style="background-color: #22c55e;">+5s</span> Extra Time</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                     <div class="text-xs space-y-3">
                        <div><strong class="font-semibold text-slate-700">Long Word Bonus:</strong>
                            <table class="w-full mt-1 text-left text-xs">
                                <tbody>
                                    <tr><td class="py-0.5 pr-2">4 Letters: <span class="font-medium">+2 pts</span></td><td class="py-0.5">6 Letters: <span class="font-medium">+10 pts</span></td></tr>
                                    <tr><td class="py-0.5 pr-2">5 Letters: <span class="font-medium">+5 pts</span></td><td class="py-0.5">7+ Letters: <span class="font-medium">+20 pts</span></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pt-2"><strong class="font-semibold text-slate-700">Letter Point Values:</strong>
                            <div id="letter-values-container" class="flex flex-wrap gap-1 mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="scroll-indicator" class="absolute bottom-0 left-1/2 -translate-x-1/2 animate-bounce-slow">
                <svg class="w-6 h-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </div>
        </div>`;
        const letterValuesContainer = container.querySelector('#letter-values-container'); if (letterValuesContainer) { const sortedLetters = Object.keys(letterConfig).sort(); const letterTilesHtml = sortedLetters.map(letter => { const config = letterConfig[letter]; return `<span class="bg-slate-200 text-slate-700 font-bold rounded-sm px-1.5 py-0.5 text-[10px] leading-none">${letter}-${config.p}</span>`; }).join(''); letterValuesContainer.innerHTML = letterTilesHtml; }
        
        const tutorialContent = container.querySelector('#tutorial-content');
        const scrollIndicator = container.querySelector('#scroll-indicator');
        tutorialContent.onscroll = () => {
            if (tutorialContent.scrollTop > 10) {
                scrollIndicator.style.display = 'none';
            } else {
                 scrollIndicator.style.display = 'block';
            }
        };

        const tutorialGridContainer = container.querySelector('#tutorial-grid-container'); const tutorialCanvas = container.querySelector('#tutorial-line-canvas'); const tutorialCtx = tutorialCanvas.getContext('2d'); const tutorialTiles = Array.from(tutorialGridContainer.querySelectorAll('.tutorial-tile')); const wordBuilder = container.querySelector('#tutorial-word-builder'); const animationSequence = [0, 4, 5, 10]; const word = 'WORM';
        const runAnimation = () => { const gridRect = tutorialGridContainer.getBoundingClientRect(); tutorialCanvas.width = gridRect.width; tutorialCanvas.height = gridRect.height; const tileCenters = tutorialTiles.map(tile => { const tileRect = tile.getBoundingClientRect(); return { x: tileRect.left + tileRect.width / 2 - gridRect.left, y: tileRect.top + tileRect.height / 2 - gridRect.top }; }); wordBuilder.innerHTML = '<span class="opacity-0">W</span>'; tutorialTiles.forEach(t => t.classList.remove('highlight')); tutorialCtx.clearRect(0, 0, tutorialCanvas.width, tutorialCanvas.height); let scoreEl = tutorialGridContainer.querySelector('.flying-score-tutorial'); if(scoreEl) scoreEl.remove(); const pathPoints = []; animationSequence.forEach((tileIndex, step) => { setTimeout(() => { tutorialTiles[tileIndex].classList.add('highlight'); const newLetterHTML = `<span class="current-letter bg-white text-blue-500 font-bold text-sm px-1 py-0.5 rounded-md shadow-sm">${word[step]}</span>`; if (step === 0) { wordBuilder.innerHTML = newLetterHTML; } else { wordBuilder.innerHTML += newLetterHTML; } pathPoints.push(tileCenters[tileIndex]); tutorialCtx.clearRect(0, 0, tutorialCanvas.width, tutorialCanvas.height); if(pathPoints.length > 1) { tutorialCtx.beginPath(); tutorialCtx.strokeStyle = 'rgba(59, 130, 246, 0.8)'; tutorialCtx.lineWidth = 8; tutorialCtx.lineCap = 'round'; tutorialCtx.lineJoin = 'round'; tutorialCtx.moveTo(pathPoints[0].x, pathPoints[0].y); for(let i = 1; i < pathPoints.length; i++) { tutorialCtx.lineTo(pathPoints[i].x, pathPoints[i].y); } tutorialCtx.stroke(); } }, 1000 + (step + 1) * 750); }); setTimeout(() => { const el = document.createElement('div'); el.className = 'flying-score'; el.style.fontSize = '1rem'; el.style.padding = '4px 8px'; el.style.animation = 'fly-up-tutorial 1.5s ease-in-out forwards'; el.style.position = 'absolute'; el.style.top = '50%'; el.style.left = '50%'; el.textContent = `+9`; el.classList.add('flying-score-tutorial'); tutorialGridContainer.appendChild(el); }, 1000 + (animationSequence.length + 1) * 750); };
        if(animationInterval) clearInterval(animationInterval); setTimeout(() => { runAnimation(); animationInterval = setInterval(runAnimation, 6000); }, 350);
    };

    document.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>
