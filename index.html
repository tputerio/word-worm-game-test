<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Word Worm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; touch-action: none; }
        .tile {
            position: relative;
            transition: all 0.2s ease-in-out; -webkit-user-select: none; user-select: none;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .tile.selected {
            background: linear-gradient(45deg, #60a5fa, #3b82f6);
            color: white; transform: scale(1.08); border-color: #2563eb;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        #game-content.blurred, #modal-content.blurred { filter: blur(8px); transform: scale(0.95); transition: all 0.3s ease-in-out; }
        #game-content, #modal-content { transition: all 0.3s ease-in-out; }
        #line-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* Bonus Tile Styles */
        .bonus-label {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 0.65rem;
            font-weight: 900;
            color: white;
            padding: 0px 4px;
            border-radius: 4px;
        }
        .bonus-DL { background-color: #3b82f6 !important; } /* Blue */
        .bonus-TL { background-color: #ef4444 !important; } /* Red */
        .bonus-DW { background-color: #f59e0b !important; } /* Amber */
        .bonus-Time { background-color: #22c55e !important; } /* Green */
        
        /* Animations */
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .animate-pulse { animation: pulse 1s infinite; }
        @keyframes fly-to-score {
            0% { transform: translate(0, 0) scale(1.2); opacity: 1; }
            100% { transform: translate(0, -180px) scale(0.5); opacity: 0; }
        }
        .flying-score {
            position: absolute; background: linear-gradient(45deg, #facc15, #f59e0b); color: white;
            padding: 8px 16px; border-radius: 9999px; font-weight: bold; font-size: 1.25rem;
            z-index: 100; animation: fly-to-score 1.5s ease-in-out forwards; pointer-events: none;
        }
        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .current-letter { animation: pop-in 0.2s ease-out; }
        .modal-enter { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .tab-button.active {
            background-color: #3b82f6;
            color: white;
        }
        
        /* Tutorial Animation */
        .tutorial-tile.highlight {
            background: linear-gradient(45deg, #60a5fa, #3b82f6);
            color: white;
            transform: scale(1.08);
            border-color: #2563eb;
        }
        @keyframes fly-up-tutorial {
            0% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -200%) scale(0.5); opacity: 0; }
        }
        #tutorial-slider.is-snapping {
            transition: transform 0.3s ease-out;
        }

        .particle {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #facc15;
            z-index: 101;
            animation: particle-anim 0.8s ease-out forwards;
        }

        @keyframes particle-anim {
            to {
                transform: var(--transform-end);
                opacity: 0;
            }
        }
        
        /* Dropdown Menu */
        .dropdown-menu {
            transition: all 0.2s ease-out;
        }
    </style>
</head>
<body class="bg-slate-100 flex justify-center items-start md:items-center min-h-screen">

<div id="game-container" class="w-full max-w-sm mx-auto p-4 relative">
    <div id="menu-container" class="absolute top-4 right-4 z-30">
        <button id="menu-button" class="bg-slate-200 hover:bg-slate-300 text-slate-700 p-2 rounded-full shadow-md transition-transform hover:scale-105">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div id="dropdown-menu" class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl origin-top-right" style="transform: scale(0.95); opacity: 0;">
            <a id="menu-home" href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">üè† Home</a>
            <a id="menu-stats" href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">üìä Your Stats</a>
            <a id="menu-leaderboard" href="#" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">üåç Leaderboard</a>
        </div>
    </div>

    <div id="game-content">
        <div class="flex items-center justify-between mb-3">
            <div class="flex-grow flex items-center justify-center">
                <h1 class="text-3xl font-black text-slate-800 tracking-tighter flex items-center justify-center">
                    <img src="https://raw.githubusercontent.com/tputerio/word-rush-game/main/word-worm-logo.png" alt="Word Worm Logo" class="w-9 h-9 mr-2">
                    <span>Word Worm</span>
                </h1>
            </div>
        </div>
        <div id="scoreboard" class="grid grid-cols-3 items-center text-center bg-white rounded-xl shadow-lg p-2 mb-3">
            <div id="top-left-display">
                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">High</div>
                <div id="high-score" class="text-3xl font-black text-slate-400">0</div>
            </div>
            <div>
                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Score</div>
                <div id="score" class="text-3xl font-black text-slate-800">0</div>
            </div>
            <div id="timer-display">
                <div class="text-xs font-bold text-slate-500 uppercase tracking-wider">Time</div>
                <div id="timer" class="text-3xl font-bold text-green-500 transition-all duration-300">60</div>
            </div>
        </div>
        <div id="current-word-container" class="mb-3 p-2 bg-slate-200 rounded-lg shadow-inner h-[52px] flex items-center justify-center">
            <div id="current-word-letters" class="flex-grow flex items-center justify-center space-x-1"></div>
        </div>
        <div id="grid-container" class="relative">
            <canvas id="line-canvas"></canvas>
            <div id="grid" class="grid grid-cols-4 gap-2 select-none"></div>
        </div>
    </div>
    
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 p-4">
        <div id="modal-content" class="w-full max-w-sm mx-auto"></div>
    </div>
    <div id="end-game-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div id="end-game-modal-content" class="w-full max-w-sm mx-auto"></div>
    </div>
    <div id="leaderboard-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div id="leaderboard-modal-content" class="w-full max-w-xs mx-auto"></div>
    </div>
    <div id="stats-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[70] p-4 overflow-y-auto">
        <div id="stats-modal-content" class="w-full max-w-xs mx-auto"></div>
    </div>
</div>

<script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, getDoc, setDoc, updateDoc, increment, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    // --- Config ---
    const [GRID_SIZE, GRID_COLS, GAME_TIME] = [16, 4, 60];
    const letterConfig={'A':{p:1},'B':{p:3},'C':{p:3},'D':{p:2},'E':{p:1},'F':{p:4},'G':{p:2},'H':{p:4},'I':{p:1},'J':{p:8},'K':{p:5},'L':{p:1},'M':{p:3},'N':{p:1},'O':{p:1},'P':{p:3},'Q':{p:10},'R':{p:1},'S':{p:1},'T':{p:1},'U':{p:1},'V':{p:4},'W':{p:4},'X':{p:8},'Y':{p:4},'Z':{p:10}};
    const VOWELS = ['A', 'E', 'I', 'O', 'U'];
    const HARD_CONSONANTS = ['J', 'K', 'Q', 'X', 'Z'];
    const LETTER_BAG_STRING = "EEEEEEEEEEEEAAAAAAAAAARRRRRRRRRRIIIIIIIIIOOOOOOOOTTTTTTTTNNNNNNNNSSSSSSSLLLLLLUUUUDDDDGGGBBCCMMPPFFHHVVWWYYKJXQZ";

    // --- DOM Elements ---
    const gameContentEl = document.getElementById('game-content');
    const gridContainer = document.getElementById('grid-container');
    const grid = document.getElementById('grid'), lineCanvas = document.getElementById('line-canvas'), ctx = lineCanvas.getContext('2d');
    const scoreEl = document.getElementById('score'), timerEl = document.getElementById('timer');
    const topLeftDisplayEl = document.getElementById('top-left-display');
    const menuContainer = document.getElementById('menu-container');
    const menuButton = document.getElementById('menu-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const currentWordLettersEl = document.getElementById('current-word-letters');
    const messageModal = document.getElementById('message-modal'), modalContent = document.getElementById('modal-content');
    const endGameModal = document.getElementById('end-game-modal'), endGameModalContent = document.getElementById('end-game-modal-content');
    const leaderboardModal = document.getElementById('leaderboard-modal'), leaderboardModalContent = document.getElementById('leaderboard-modal-content');
    const statsModal = document.getElementById('stats-modal'), statsModalContent = document.getElementById('stats-modal-content');

    // --- Firebase State ---
    let auth, db, userId;

    // --- Game State ---
    let score = 0, timer = GAME_TIME, timerInterval, wordSet = new Set(), foundWords = [], selectedTiles = [], isMouseDown = false;
    let tilePositions = [], dictionaryTrie;
    let isPracticeMode = false; 
    let practiceTimeElapsed = 0;

    // --- Trie Data Structure ---
    class TrieNode { constructor() { this.children = {}; this.isEndOfWord = false; } }
    class Trie {
        constructor() { this.root = new TrieNode(); }
        insert(word) { let node = this.root; for(const char of word) { if(!node.children[char]) node.children[char] = new TrieNode(); node = node.children[char]; } node.isEndOfWord = true; }
        search(word, isPrefix = false) { let node = this.root; for(const char of word) { if(!node.children[char]) return false; node = node.children[char]; } return isPrefix ? true : node.isEndOfWord; }
    }

    // --- Init ---
    function main() {
        setupEventListeners();
        topLeftDisplayEl.innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider">High</div><div id="high-score" class="text-3xl font-black text-slate-400">0</div>`;
        showWelcomeScreen();
        loadAssets(); 
    }
    
    async function loadAssets() {
        const playGameModeButton = document.getElementById('play-game-mode-button');
        const playPracticeButton = document.getElementById('play-practice-button');
        const loadingErrorEl = document.getElementById('loading-error');
        const showLeaderboardButton = document.getElementById('show-leaderboard-button');

        if (playGameModeButton) {
            playGameModeButton.disabled = true;
            playGameModeButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Loading...</span></div>`;
        }
        if (playPracticeButton) {
            playPracticeButton.disabled = true;
            playPracticeButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Loading...</span></div>`;
        }

        try {
            const res = await fetch('https://raw.githubusercontent.com/redbo/scrabble/master/dictionary.txt');
            if (!res.ok) throw new Error(`Dictionary download failed: ${res.statusText}`);
            const words = (await res.text()).split('\n').map(w => w.trim().toUpperCase()).filter(w => w.length >= 3);
            wordSet = new Set(words); wordSet.add("ZEN"); wordSet.add("KIN");
            dictionaryTrie = new Trie();
            for (const word of wordSet) dictionaryTrie.insert(word);
            console.log("Dictionary loaded. Game is playable.");
            
            if (playGameModeButton) { playGameModeButton.disabled = false; playGameModeButton.innerHTML = `<div class="flex items-center justify-center"><span class="mr-2">‚ö°</span><span>Game Mode</span></div>`; }
            if (playPracticeButton) { playPracticeButton.disabled = false; playPracticeButton.innerHTML = `<div class="flex items-center justify-center"><span class="mr-2">üìñ</span><span>Practice</span></div>`; }

        } catch (e) {
            console.error("Critical Asset loading failed (Dictionary):", e);
            if (loadingErrorEl) loadingErrorEl.textContent = "Error: Could not load game dictionary.";
            if (playGameModeButton) { playGameModeButton.innerHTML = `<span>Error</span>`; playGameModeButton.classList.add('bg-red-500'); }
            if (playPracticeButton) { playPracticeButton.innerHTML = `<span>Error</span>`; playPracticeButton.classList.add('bg-red-500'); }
            return;
        }

        try {
            const firebaseConfig = { apiKey: "AIzaSyBa2DPRjwaI-G5mz-OmHVXEDJ4_MzBAZgA", authDomain: "word-rush-game-9010a.firebaseapp.com", projectId: "word-rush-game-9010a", storageBucket: "word-rush-game-9010a.appspot.com", messagingSenderId: "551838491871", appId: "1:551838491871:web:757325be04daab9289b56a" };
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase connected. User ID:", userId);
                    if (showLeaderboardButton) showLeaderboardButton.disabled = false;
                    fetchGlobalStats();
                    fetchPlayerStats(userId); // Fetch player-specific stats
                } else {
                    signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                }
            });

        } catch (firebaseError) {
            console.warn("Firebase features failed to load, continuing in offline mode:", firebaseError);
            const globalPlayCountSpan = document.getElementById('global-play-count');
            if (globalPlayCountSpan) globalPlayCountSpan.textContent = "N/A";
            if (showLeaderboardButton) { showLeaderboardButton.disabled = true; showLeaderboardButton.classList.add('opacity-50'); }
        }
    }

    async function fetchGlobalStats() {
        const globalPlayCountSpan = document.getElementById('global-play-count');
        if (!db || !globalPlayCountSpan) return;
        try {
            const statsRef = doc(db, "gameStats", "stats");
            const docSnap = await getDoc(statsRef);
            if (docSnap.exists()) {
                globalPlayCountSpan.textContent = docSnap.data().playCount.toLocaleString();
            } else {
                globalPlayCountSpan.textContent = "0";
            }
        } catch(e) {
            console.warn("Could not fetch global stats:", e);
            if (globalPlayCountSpan) globalPlayCountSpan.textContent = "N/A";
        }
    }

    async function fetchPlayerStats(uid) {
        if (!db) return;
        const playerDocRef = doc(db, "players", uid);
        try {
            const docSnap = await getDoc(playerDocRef);
            let highScore = 0;
            let gamesPlayed = 0;
            let playerName = 'Anonymous';

            if (docSnap.exists()) {
                const playerData = docSnap.data();
                highScore = playerData.highScore || 0;
                gamesPlayed = playerData.totalGamesPlayed || 0;
                playerName = playerData.name && playerData.name !== 'Anonymous' ? playerData.name : 'Anonymous';
            }

            // Update all relevant UI elements with data from Firebase
            const highScoreEl = document.getElementById('high-score');
            if (highScoreEl) highScoreEl.textContent = highScore;

            const welcomeHighScoreEl = document.getElementById('welcome-high-score');
            if (welcomeHighScoreEl) welcomeHighScoreEl.textContent = highScore;
            
            const playerStatsDisplayEl = document.getElementById('player-stats-display');
            if (playerStatsDisplayEl) {
                playerStatsDisplayEl.innerHTML = `Playing as <strong class="text-slate-500">${playerName}</strong> | You‚Äôve played <strong class="text-slate-500">${gamesPlayed}</strong> games!`;
            }

        } catch (e) {
            console.error("Could not fetch player stats:", e);
        }
    }
    
    function createGrid() {
        const board = generateAndValidateBoard();
        grid.innerHTML = '';
        for (let i = 0; i < GRID_SIZE; i++) {
            const letter = board[i];
            const points = letterConfig[letter].p;
            const tile = document.createElement('div');
            tile.className = 'tile w-full aspect-square border-2 border-slate-300 bg-white rounded-lg flex items-center justify-center text-3xl font-bold text-slate-800 cursor-pointer';
            tile.dataset.letter = letter; tile.dataset.points = points; tile.dataset.id = i;
            tile.innerHTML = `<span>${letter}<sub class="text-xs font-semibold ml-1">${points}</sub></span>`;
            const bonusType = getBonusType();
            if (bonusType) {
                tile.dataset.bonus = bonusType.type;
                tile.classList.add(bonusType.class);
                tile.innerHTML += `<div class="bonus-label">${bonusType.label}</div>`;
            }
            grid.appendChild(tile);
        }
        setTimeout(resizeCanvas, 0);
    }
    
    function getRandomLetter() { return LETTER_BAG_STRING[Math.floor(Math.random() * LETTER_BAG_STRING.length)]; }
    function getBonusType() {
        const rand = Math.random();
        if (rand < 0.08) return { type: 'Time', label: '+5s', class: 'bonus-Time' };
        if (rand < 0.18) return { type: 'DW', label: 'DW', class: 'bonus-DW' };
        if (rand < 0.28) return { type: 'TL', label: 'TL', class: 'bonus-TL' };
        if (rand < 0.40) return { type: 'DL', label: 'DL', class: 'bonus-DL' };
        return null;
    }

    function startGame(practiceMode = false) {
        isPracticeMode = practiceMode; 
        clearInterval(timerInterval); 
        score = 0; 
        foundWords = []; 
        updateScoreDisplay(); 
        
        if (isPracticeMode) {
            practiceTimeElapsed = 0;
            topLeftDisplayEl.innerHTML = `<div class="text-xs font-bold text-blue-500 uppercase tracking-wider">Pace</div><div id="pace-score" class="text-3xl font-black text-blue-400">0</div>`;
            updatePracticeUI(); 
            timerInterval = setInterval(() => {
                practiceTimeElapsed++;
                updatePracticeUI();
            }, 1000);
        } else {
            // High score is now set from Firebase, so we ensure the display is correct
            const currentHighScore = document.getElementById('high-score').textContent || '0';
            topLeftDisplayEl.innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider">High</div><div id="high-score" class="text-3xl font-black text-slate-400">${currentHighScore}</div>`;
            timer = GAME_TIME; 
            updateTimerUI(); 
            // Game count is now handled by Firebase, no need to update localStorage
            if (db) { const statsRef = doc(db, "gameStats", "stats"); updateDoc(statsRef, { playCount: increment(1) }).catch(console.warn); }
            timerInterval = setInterval(() => { timer--; updateTimerUI(); if (timer <= 0) endGame(); }, 1000);
        }

        menuContainer.classList.remove('hidden');
        gameContentEl.classList.remove('blurred');
        messageModal.classList.add('hidden');
        createGrid();
        grid.style.pointerEvents = 'auto'; 
    }
    
    function endGame() {
        clearInterval(timerInterval);
        grid.style.pointerEvents = 'none';
        menuContainer.classList.add('hidden');

        if (!isPracticeMode) { 
            saveGameHistoryAndStats(score);
        } else {
            resetGame();
        }
    }

    function resetGame() {
        clearInterval(timerInterval);
        endGameModal.classList.add('hidden');
        statsModal.classList.add('hidden');
        score = 0;
        foundWords = [];
        updateScoreDisplay();

        const highScoreEl = document.getElementById('high-score');
        const currentHighScore = highScoreEl ? highScoreEl.textContent : '0';

        topLeftDisplayEl.innerHTML = `<div class="text-xs font-bold text-slate-500 uppercase tracking-wider">High</div><div id="high-score" class="text-3xl font-black text-slate-400">${currentHighScore}</div>`;
        showWelcomeScreen();
        loadAssets();
    }
    
    function handleInteraction(tile) {
        if (!tile || !isMouseDown) return;
        const lastSelected = selectedTiles[selectedTiles.length - 1];
        if (selectedTiles.length > 1 && tile === selectedTiles[selectedTiles.length - 2]) {
            const lastTile = selectedTiles.pop();
            lastTile.classList.remove('selected');
        } else if (!selectedTiles.includes(tile) && (!lastSelected || isAdjacent(tile, lastSelected))) {
            selectedTiles.push(tile);
            tile.classList.add('selected');
        }
        updateCurrentWord();
        drawLines();
    }
    
    function isAdjacent(t1, t2) {
        if (!t1 || !t2) return false;
        const id1 = parseInt(t1.dataset.id), id2 = parseInt(t2.dataset.id);
        const [c1, r1] = [id1 % GRID_COLS, Math.floor(id1 / GRID_COLS)];
        const [c2, r2] = [id2 % GRID_COLS, Math.floor(id2 / GRID_COLS)];
        return Math.abs(c1 - c2) <= 1 && Math.abs(r1 - r2) <= 1;
    }

    function submitWord() {
        const word = selectedTiles.map(t => t.dataset.letter).join('');
        if (word.length >= 3 && wordSet.has(word)) {
            let baseScore = 0; let wordMultiplier = 1; let timeBonus = 0;
            selectedTiles.forEach(tile => {
                let letterScore = parseInt(tile.dataset.points);
                switch(tile.dataset.bonus) {
                    case 'DL': letterScore *= 2; break; case 'TL': letterScore *= 3; break;
                    case 'DW': wordMultiplier *= 2; break; case 'Time': timeBonus += 5; break;
                }
                baseScore += letterScore;
            });
            let finalScore = baseScore * wordMultiplier;
            if (word.length >= 7) finalScore += 20;
            else if (word.length === 6) finalScore += 10;
            else if (word.length === 5) finalScore += 5;
            else if (word.length === 4) finalScore += 2;
            if (timeBonus > 0 && !isPracticeMode) {
                timer += timeBonus; 
                updateTimerUI();
            }
            foundWords.push({ word, score: finalScore, length: word.length });
            createFlyingScore(finalScore, selectedTiles[0]);
            triggerConfetti(selectedTiles);
            setTimeout(() => { score += finalScore; updateScoreDisplay(); }, 500);
            replaceSelectedTiles();
        }
        clearSelection();
    }

    function replaceSelectedTiles() {
        let currentBoardLetters = Array.from(grid.children).map(t => t.dataset.letter);
        selectedTiles.forEach(tile => { const index = parseInt(tile.dataset.id); currentBoardLetters[index] = null; });
        const newBoard = generateAndValidateBoard(currentBoardLetters);
        selectedTiles.forEach((tile) => {
            const index = parseInt(tile.dataset.id); const letter = newBoard[index]; const points = letterConfig[letter].p;
            tile.dataset.letter = letter; tile.dataset.points = points; tile.style.transform = 'scale(0)'; tile.dataset.bonus = '';
            tile.classList.remove('bonus-DL', 'bonus-TL', 'bonus-DW', 'bonus-Time');
            setTimeout(() => {
                tile.innerHTML = `<span>${letter}<sub class="text-xs font-semibold ml-1">${points}</sub></span>`;
                const bonusType = getBonusType();
                if (bonusType) { tile.dataset.bonus = bonusType.type; tile.classList.add(bonusType.class); tile.innerHTML += `<div class="bonus-label">${bonusType.label}</div>`; }
                tile.style.transform = 'scale(1)';
            }, 200);
        });
    }
    
    function clearSelection() { selectedTiles.forEach(t => t.classList.remove('selected')); selectedTiles = []; updateCurrentWord(); drawLines(); }
    
    async function saveGameHistoryAndStats(finalScore) {
        if (!db || !userId || isPracticeMode) {
            if (!isPracticeMode) showEndGameScreen();
            return;
        }

        const playerDocRef = doc(db, "players", userId);
        const gameData = { score: finalScore, timestamp: serverTimestamp(), words: foundWords.map(w => ({ word: w.word, score: w.score, length: w.length })) };
        
        try {
            await addDoc(collection(db, `players/${userId}/games`), gameData);
            
            await runTransaction(db, async (transaction) => {
                const playerDoc = await transaction.get(playerDocRef);
                const oldData = playerDoc.exists() ? playerDoc.data() : {};
                
                const newHighScore = Math.max(finalScore, oldData.highScore || 0);
                
                const currentBestWord = oldData.bestWord || { score: 0, word: ''};
                const gameBestWord = foundWords.length > 0 ? foundWords.reduce((best, current) => current.score > best.score ? current : best, { score: 0 }) : { score: 0, word: ''};
                const newBestWord = gameBestWord.score > currentBestWord.score ? { word: gameBestWord.word, score: gameBestWord.score } : currentBestWord;

                const updateData = {
                    totalGamesPlayed: increment(1),
                    totalPoints: increment(finalScore),
                    lastPlayed: serverTimestamp(),
                    highScore: newHighScore,
                    bestWord: newBestWord
                };
                
                if (playerDoc.exists()) {
                    transaction.update(playerDocRef, updateData);
                } else {
                    updateData.name = localStorage.getItem('wordRushPlayerName') || 'Anonymous';
                    transaction.set(playerDocRef, updateData);
                }
            });
            
            showEndGameScreen();

        } catch (e) {
            console.error("Error saving game history:", e);
            showEndGameScreen();
        }
    }

    async function submitLeaderboardScore(name, scoreToSave) {
        if (!name || scoreToSave === 0 || !db || !userId || isPracticeMode) return; 
        localStorage.setItem('wordRushPlayerName', name);
        await setDoc(doc(db, "players", userId), { name: name }, { merge: true });

        const gameBestWord = foundWords.length > 0 ? foundWords.reduce((best, current) => current.score > best.score ? current : best, { score: 0 }) : null;

        const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
        const dailyEntriesRef = collection(db, `dailyScores/${today}/entries`);
        const dailyData = { name, score: scoreToSave, userId, timestamp: serverTimestamp() };
        if (gameBestWord) {
            dailyData.bestWord = { word: gameBestWord.word, score: gameBestWord.score };
        }
        try { await addDoc(dailyEntriesRef, dailyData); } catch (e) { console.error("Failed to submit daily score:", e); }
    }
    
    function updateScoreDisplay() {
        scoreEl.textContent = score;
        scoreEl.classList.add('animate-pulse');
        scoreEl.addEventListener('animationend', () => scoreEl.classList.remove('animate-pulse'), { once: true });
        if (!isPracticeMode) {
            const highScoreEl = document.getElementById('high-score');
            const currentHighScore = parseInt(highScoreEl.textContent) || 0;
            if (score > currentHighScore) { 
                highScoreEl.textContent = score; 
                highScoreEl.classList.add('text-yellow-500', 'animate-pulse');
            }
        } else {
            updatePracticeUI();
        }
    }

    function updateTimerUI() {
        timerEl.textContent = timer;
        timerEl.classList.remove('text-green-500', 'text-yellow-500', 'text-red-500', 'animate-pulse');
        if (timer <= 10) { timerEl.classList.add('text-red-500', 'animate-pulse'); } 
        else if (timer <= 30) { timerEl.classList.add('text-yellow-500'); } 
        else { timerEl.classList.add('text-green-500'); }
    }
    
    function updatePracticeUI() {
        const minutes = Math.floor(practiceTimeElapsed / 60);
        const seconds = practiceTimeElapsed % 60;
        timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        timerEl.classList.remove('text-yellow-500', 'text-red-500', 'animate-pulse');
        timerEl.classList.add('text-green-500');
        
        const pace = Math.round((score / Math.max(1, practiceTimeElapsed)) * 60);
        const paceScoreEl = document.getElementById('pace-score');
        if (paceScoreEl) {
            paceScoreEl.textContent = isNaN(pace) ? 0 : pace;
        }
    }

    function triggerConfetti(tiles) { tiles.forEach(tile => { const rect = tile.getBoundingClientRect(); for (let i = 0; i < 10; i++) { const p = document.createElement('div'); p.className = 'particle'; const angle = Math.random() * Math.PI * 2, dist = Math.random() * 40 + 20; p.style.setProperty('--transform-end',`translate(${Math.cos(angle)*dist}px,${Math.sin(angle)*dist}px)`); p.style.left = `${rect.left+rect.width/2-4}px`; p.style.top = `${rect.top+rect.height/2-4}px`; document.body.appendChild(p); setTimeout(() => p.remove(), 800); } }); }
    function createFlyingScore(points, startTile) { const el = document.createElement('div'); el.className = 'flying-score'; el.style.animation = 'none'; el.style.position = 'absolute'; el.textContent = `+${points}`; const rect = startTile.getBoundingClientRect(); el.style.left = `${rect.left}px`; el.style.top = `${rect.top}px`; document.body.appendChild(el); setTimeout(() => { el.style.animation = 'fly-to-score 1.5s ease-in-out forwards'; }, 10); setTimeout(() => el.remove(), 1500); }
    function updateCurrentWord() { currentWordLettersEl.innerHTML = selectedTiles.map(t => `<span class="current-letter bg-white text-blue-500 font-bold text-xl p-1 rounded-md shadow-sm">${t.dataset.letter}</span>`).join(''); }

    function showWelcomeScreen() {
        modalContent.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl p-6 text-center modal-enter">
                <h1 class="text-4xl font-black text-slate-800 tracking-tighter mb-1 flex items-center justify-center">
                    <img src="https://raw.githubusercontent.com/tputerio/word-rush-game/main/word-worm-logo.png" alt="Word Worm Logo" class="w-12 h-12 mr-2">
                    <span>Word Worm</span>
                </h1>
                <p class="text-slate-500 text-sm mb-4">The fast-paced word finding game!</p>
                <div id="how-to-play-container" class="relative bg-slate-100 p-3 rounded-lg mb-4 h-[17rem] overflow-hidden"></div>
                <div class="flex flex-col sm:flex-row sm:space-x-4 mb-3">
                    <button id="play-practice-button" class="bg-blue-500 hover:bg-blue-600 flex-1 text-white font-bold py-2 px-4 rounded-lg text-base shadow-lg transition-transform hover:scale-105 mb-3 sm:mb-0 disabled:bg-slate-400 disabled:cursor-wait">...</button>
                    <button id="play-game-mode-button" class="bg-green-500 hover:bg-green-600 flex-1 text-white font-bold py-2 px-4 rounded-lg text-base shadow-lg transition-transform hover:scale-105 disabled:bg-slate-400 disabled:cursor-wait">...</button>
                </div>
                <div class="flex justify-between items-center border-t border-slate-200 pt-3">
                    <div class="font-bold text-slate-600 text-base flex items-center">
                        <span class="text-xl mr-1">üèÜ</span>Your High: <span id="welcome-high-score">0</span>
                    </div>
                    <button id="show-leaderboard-button" class="font-bold text-green-500 hover:text-green-600 text-base flex items-center" disabled>
                        Leaderboard <span class="text-xl ml-1">üåç</span>
                    </button>
                </div>
                <p id="player-stats-display" class="text-xs text-slate-400 mt-3"></p>
                <p class="text-xs text-slate-400 mt-1"><span id="global-play-count">...</span> games played globally</p>
                <p id="loading-error" class="text-red-500 mt-2 font-semibold"></p>
            </div>
        `;
        gameContentEl.classList.remove('blurred');
        menuContainer.classList.add('hidden'); 
        messageModal.classList.remove('hidden');
        setupTutorial();
        document.getElementById('play-game-mode-button').onclick = () => startGame(false);
        document.getElementById('play-practice-button').onclick = () => startGame(true);
        document.getElementById('show-leaderboard-button').onclick = showLeaderboardModal;
    }

    async function showLeaderboardModal() {
        leaderboardModal.classList.remove('hidden');
        gameContentEl.classList.add('blurred');
        leaderboardModalContent.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl p-6 text-center w-full max-w-xs mx-auto modal-enter">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center justify-center">Leaderboard <span class="text-2xl ml-2">üåç</span></h2>
            <div class="flex p-1 bg-slate-200 rounded-lg mb-4">
                <button id="daily-tab" class="tab-button flex-1 py-1 px-2 rounded-md font-semibold text-sm transition-colors duration-200">Daily</button>
                <button id="all-time-tab" class="tab-button flex-1 py-1 px-2 rounded-md font-semibold text-sm transition-colors duration-200">All-Time</button>
            </div>
            <div id="leaderboard-loading-secondary" class="text-slate-500 p-2">Fetching Scores...</div>
            <div id="leaderboard-scroll-container" class="relative max-h-[20rem] overflow-y-auto">
                <div id="leaderboard-list-simple" class="space-y-2 text-left"></div>
            </div>
            <button id="close-leaderboard-button" class="mt-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Close</button>
        </div>`;
        const dailyTab = document.getElementById('daily-tab');
        const allTimeTab = document.getElementById('all-time-tab');
        const listEl = document.getElementById('leaderboard-list-simple');
        const loadingEl = document.getElementById('leaderboard-loading-secondary');
        const displayTab = (type) => {
            if (!db) { listEl.innerHTML = `<p class="text-red-500 text-center p-4">Leaderboard is offline.</p>`; if (loadingEl) loadingEl.style.display = 'none'; return; }
            if(type === 'daily') { dailyTab.classList.add('active'); allTimeTab.classList.remove('active'); fetchAndDisplayLeaderboard('daily', listEl, loadingEl); } 
            else { allTimeTab.classList.add('active'); dailyTab.classList.remove('active'); fetchAndDisplayLeaderboard('all-time', listEl, loadingEl); }
        };
        dailyTab.onclick = () => displayTab('daily');
        allTimeTab.onclick = () => displayTab('all-time');
        displayTab('daily'); 
        document.getElementById('close-leaderboard-button').onclick = () => { leaderboardModal.classList.add('hidden'); gameContentEl.classList.remove('blurred'); };
    }

    async function showStatsModal() {
        statsModal.classList.remove('hidden');
        gameContentEl.classList.add('blurred');
        statsModalContent.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl p-6 text-center modal-enter">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Loading Your Stats...</h2>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-900 mx-auto"></div>
        </div>`;
        
        const stats = await fetchAndCalculateStats();

        let statsHTML;
        if (!stats) {
            statsHTML = `<div class="bg-white rounded-2xl shadow-2xl p-6 modal-enter">
                <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-slate-800">üìä Your Stats</h2><button id="close-stats-button" class="text-3xl leading-none text-slate-500 hover:text-slate-800">&times;</button></div>
                <p class="text-slate-500 text-center py-8">Play a game to see your stats here!</p>
            </div>`;
        } else {
            statsHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 modal-enter">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-slate-800 flex items-center">üìä<span class="ml-2">Your Stats</span></h2><button id="close-stats-button" class="text-3xl leading-none text-slate-500 hover:text-slate-800">&times;</button></div>
                    <div class="grid grid-cols-3 gap-4 text-center mb-6 bg-slate-100 p-3 rounded-lg">
                        <div><div class="text-xs font-bold text-slate-500 uppercase">Total Games</div><div class="text-2xl font-black text-slate-800">${stats.totalGamesPlayed}</div></div>
                        <div><div class="text-xs font-bold text-slate-500 uppercase">Total Words</div><div class="text-2xl font-black text-slate-800">${stats.totalWordsFound}</div></div>
                        <div><div class="text-xs font-bold text-slate-500 uppercase">Total Score</div><div class="text-2xl font-black text-slate-800">${stats.totalScore.toLocaleString()}</div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><h3 class="text-base font-bold text-slate-700 mb-2 border-b pb-1">Best Scores</h3><ol class="space-y-1 text-sm">${stats.top10Scores.map((s, i) => `<li class="flex justify-between p-1 ${i%2 === 0 ? 'bg-slate-50' : ''} rounded"><span><strong>${s.score}</strong></span><span class="text-slate-500">${s.date}</span></li>`).join('')}</ol></div>
                        <div><h3 class="text-base font-bold text-slate-700 mb-2 border-b pb-1">Longest Words</h3><ol class="space-y-1 text-sm">${stats.top10LongestWords.map((w, i) => `<li class="p-1 ${i%2 === 0 ? 'bg-slate-50' : ''} rounded"><strong>${w.word}</strong> (${w.length})</li>`).join('')}</ol></div>
                    </div>
                </div>`;
        }
        
        statsModalContent.innerHTML = statsHTML;
        document.getElementById('close-stats-button').onclick = () => { statsModal.classList.add('hidden'); gameContentEl.classList.remove('blurred'); };
    }

    async function fetchAndCalculateStats() {
        if (!db || !userId) return null;
        const gamesRef = collection(db, `players/${userId}/games`);
        const querySnapshot = await getDocs(query(gamesRef, orderBy('timestamp', 'desc')));
        if (querySnapshot.empty) return null;
        let totalScore = 0; let allWords = []; let allGames = [];
        querySnapshot.forEach(doc => {
            const game = doc.data(); totalScore += game.score; allWords.push(...(game.words || []));
            allGames.push({ score: game.score, date: game.timestamp ? game.timestamp.toDate().toLocaleDateString() : 'N/A' });
        });
        const top10Scores = allGames.sort((a, b) => b.score - a.score).slice(0, 10);
        const uniqueLongestWords = [...new Map(allWords.map(item => [item.word, item])).values()];
        const top10LongestWords = uniqueLongestWords.sort((a,b) => b.length - a.length).slice(0, 10);
        return { totalGamesPlayed: querySnapshot.size, totalWordsFound: allWords.length, totalScore, top10Scores, top10LongestWords };
    }
    
    async function fetchAndDisplayLeaderboard(type, listElement, loadingElement) {
        if (!listElement) return;
        if (loadingElement) loadingElement.style.display = 'block';
        listElement.innerHTML = '';
        if (!db) { listElement.innerHTML = `<p class="text-red-500 text-center p-4">Leaderboard is offline.</p>`; if (loadingElement) loadingElement.style.display = 'none'; return; }

        try {
            let html = '';
            if (type === 'all-time') {
                const categories = [
                    { field: 'highScore', title: 'üèÜ High Score' },
                    { field: 'totalPoints', title: 'üìà Total Points' },
                    { field: 'bestWord.score', title: '‚ú® Best Word' }
                ];
                for (const cat of categories) {
                    const q = query(collection(db, 'players'), orderBy(cat.field, 'desc'), limit(10));
                    const snapshot = await getDocs(q);
                    html += `<h3 class="text-lg font-bold text-slate-800 my-2 sticky top-0 bg-white py-1 flex items-center">${cat.title}</h3>`;
                    
                    const docsWithNames = snapshot.docs.filter(doc => doc.data().name && doc.data().name !== 'Anonymous');

                    if (docsWithNames.length === 0) {
                        html += `<p class="text-slate-500 text-center text-sm p-2">No players in this category yet.</p>`;
                    } else {
                        const scores = docsWithNames.map((doc, i) => {
                            const data = doc.data();
                            let value;
                            if (cat.field === 'bestWord.score') {
                                value = data.bestWord && data.bestWord.word ? `${data.bestWord.word} (${data.bestWord.score})` : 'N/A';
                            } else {
                                value = data[cat.field]?.toLocaleString() || 0;
                            }
                            return `<li class="flex items-center p-2 rounded-lg ${i % 2 === 0 ? 'bg-slate-50' : ''}"><span class="font-bold text-slate-500 w-8 text-center">${i + 1}.</span><span class="font-semibold text-slate-800 flex-grow truncate mr-4">${data.name}</span><span class="font-bold text-green-500">${value}</span></li>`;
                        });
                        html += `<ol class="space-y-1">${scores.join('')}</ol>`;
                    }
                }
                listElement.innerHTML = html;

            } else { // Daily
                const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
                const dailyRef = collection(db, `dailyScores/${today}/entries`);
                const q = query(dailyRef, orderBy("timestamp", "desc"));
                const snapshot = await getDocs(q);

                const dailyHighScores = new Map();
                const dailyTotalScores = new Map();
                const dailyBestWords = new Map();

                snapshot.forEach(doc => {
                    const { userId, name, score, bestWord } = doc.data();
                    if(!userId || !name || typeof score !== 'number') return;
                    
                    if (!dailyHighScores.has(userId) || score > dailyHighScores.get(userId).score) {
                        dailyHighScores.set(userId, { name, score });
                    }
                    dailyTotalScores.set(userId, { name, score: (dailyTotalScores.get(userId)?.score || 0) + score });
                    if (bestWord && typeof bestWord.score === 'number') {
                        if (!dailyBestWords.has(userId) || bestWord.score > dailyBestWords.get(userId).score) {
                            dailyBestWords.set(userId, { name, bestWord });
                        }
                    }
                });

                const highScoresList = [...dailyHighScores.values()].sort((a,b) => b.score - a.score);
                const totalScoresList = [...dailyTotalScores.values()].sort((a,b) => b.score - a.score);
                const bestWordsList = [...dailyBestWords.values()].sort((a,b) => b.bestWord.score - a.bestWord.score);
                
                const createCategoryHTML = (title, emoji, scores, formatter) => {
                    let html = `<h3 class="text-lg font-bold text-slate-800 my-2 sticky top-0 bg-white py-1 flex items-center">${emoji} <span class="ml-2">${title}</span></h3>`;
                    if(scores.length === 0) {
                        html += `<p class="text-slate-500 text-center text-sm p-2">No scores yet today.</p>`;
                    } else {
                        html += `<ol class="space-y-1">${scores.slice(0, 10).map((s, i) => `<li class="flex items-center p-2 rounded-lg ${i % 2 === 0 ? 'bg-slate-50' : ''}"><span class="font-bold text-slate-500 w-8 text-center">${i + 1}.</span><span class="font-semibold text-slate-800 flex-grow truncate mr-4">${s.name}</span><span class="font-bold text-green-500">${formatter(s)}</span></li>`).join('')}</ol>`;
                    }
                    return html;
                }

                html += createCategoryHTML('High Score', 'üèÜ', highScoresList, (s) => s.score);
                html += createCategoryHTML('Total Points', 'üìà', totalScoresList, (s) => s.score.toLocaleString());
                html += createCategoryHTML('Best Word', '‚ú®', bestWordsList, (s) => `${s.bestWord.word} (${s.bestWord.score})`);

                listElement.innerHTML = html;
            }
        } catch (e) {
            console.error(`Could not fetch ${type} leaderboard`, e);
            listElement.innerHTML = `<p class="text-red-500 text-center p-4">Could not load leaderboard.</p>`;
        } finally {
            if (loadingElement) loadingElement.style.display = 'none';
        }
    }
    
    function setupEventListeners() {
        const getTileFromEvent = (e) => { const touch = e.touches ? e.touches[0] : e; const point = { x: touch.clientX, y: touch.clientY }; let closestTile = null; let minDistance = Infinity; tilePositions.forEach(tilePos => { const distance = Math.sqrt((point.x - tilePos.center.x)**2 + (point.y - tilePos.center.y)**2); if (distance < minDistance && distance < tilePos.hitRadius) { minDistance = distance; closestTile = tilePos.el; } }); return closestTile; };
        const startInteraction = e => { e.preventDefault(); isMouseDown = true; clearSelection(); const tile = getTileFromEvent(e); handleInteraction(tile); };
        const moveInteraction = e => { if (!isMouseDown) return; e.preventDefault(); const tile = getTileFromEvent(e); handleInteraction(tile); };
        const endInteraction = () => { if (!isMouseDown) return; submitWord(); isMouseDown = false; };
        grid.addEventListener('pointerdown', startInteraction); grid.addEventListener('pointermove', moveInteraction); grid.addEventListener('pointerup', endInteraction); grid.addEventListener('pointerleave', endInteraction); 
        window.addEventListener('resize', resizeCanvas);
        menuButton.addEventListener('click', (e) => { e.stopPropagation(); const isHidden = dropdownMenu.classList.contains('hidden'); if (isHidden) { dropdownMenu.classList.remove('hidden'); setTimeout(() => { dropdownMenu.style.opacity = '1'; dropdownMenu.style.transform = 'scale(1)'; }, 10); } else { dropdownMenu.style.opacity = '0'; dropdownMenu.style.transform = 'scale(0.95)'; setTimeout(() => dropdownMenu.classList.add('hidden'), 200); } });
        document.addEventListener('click', () => { if (!dropdownMenu.classList.contains('hidden')) { dropdownMenu.style.opacity = '0'; dropdownMenu.style.transform = 'scale(0.95)'; setTimeout(() => dropdownMenu.classList.add('hidden'), 200); } });
        document.getElementById('menu-home').addEventListener('click', (e) => { e.preventDefault(); resetGame(); });
        document.getElementById('menu-stats').addEventListener('click', (e) => { e.preventDefault(); showStatsModal(); });
        document.getElementById('menu-leaderboard').addEventListener('click', (e) => { e.preventDefault(); showLeaderboardModal(); });
    }
    
    function cacheTilePositions(){tilePositions=[];for(const t of grid.children){const e=t.getBoundingClientRect();tilePositions.push({el:t,center:{x:e.left+e.width/2,y:e.top+e.height/2},hitRadius:.4*t.offsetWidth})}}
    function resizeCanvas(){const t=grid.getBoundingClientRect();lineCanvas.width=t.width,lineCanvas.height=t.height,cacheTilePositions(),drawLines()}
    function drawLines(){if(clearLines(),!(selectedTiles.length<2)){ctx.beginPath(),ctx.strokeStyle="rgba(59, 130, 246, 0.8)",ctx.lineWidth=12,ctx.lineCap="round",ctx.lineJoin="round",selectedTiles.forEach((t,e)=>{const o=getTileCenter(t);0===e?ctx.moveTo(o.x,o.y):ctx.lineTo(o.x,o.y)}),ctx.stroke()}}
    function clearLines(){ctx.clearRect(0,0,lineCanvas.width,lineCanvas.height)}
    function getTileCenter(t){const e=grid.getBoundingClientRect(),o=t.getBoundingClientRect();return{x:o.left+o.width/2-e.left,y:o.top+o.height/2-e.top}}
    function checkNoClumps(board) {for(let r=0;r<=2;r++)for(let c=0;c<=2;c++){const t=r*GRID_COLS+c,e=t+1,o=t+GRID_COLS,l=o+1;const n=[board[t],board[e],board[o],board[l]];if(n.every(l=>VOWELS.includes(l))||n.every(l=>!VOWELS.includes(l)))return!1}return!0}
    function generateAndValidateBoard(t=null){let e;let o=0;for(let l=0;l<200;l++){if(o++,e=t?[...t]:new Array(GRID_SIZE).fill(null),e.forEach((t,o)=>{null===t&&(e[o]=getRandomLetter())}),dictionaryTrie&&isBoardPlayable(e))return e;if(!dictionaryTrie&&l>0)return e;e=null}return console.warn("Failed to generate a high-quality board after 200 attempts, using last random attempt."),e||Array.from({length:GRID_SIZE},()=>getRandomLetter())}
    function isBoardPlayable(t){if(t.filter(t=>VOWELS.includes(t)).length<3||t.filter(t=>VOWELS.includes(t)).length>7)return!1;if(t.filter(t=>HARD_CONSONANTS.includes(t)).length>1)return!1;const e=t.indexOf("Q");if(-1!==e&&!getNeighbors(e,t).some(t=>"U"===t))return!1;const o=solveBoard(t);return!(Array.from(o).filter(t=>t.length>=4).length<2||Array.from(o).filter(t=>3===t.length).length<2)&&checkNoClumps(t)}
    function getNeighbors(t,e){const o=[];const[l,n]=[t%GRID_COLS,Math.floor(t/GRID_COLS)];for(let s=-1;s<=1;s++)for(let a=-1;a<=1;a++){if(0===s&&0===a)continue;const[r,i]=[l+s,n+a];r>=0&&r<GRID_COLS&&i>=0&&i<GRID_COLS&&o.push(e[i*GRID_COLS+r])}return o}
    function solveBoard(t){const e=new Set;for(let o=0;o<GRID_SIZE;o++)findWordsRecursive(o,"",[o],e,t);return e}
    function findWordsRecursive(t,e,o,l,n){if(e+=n[t],!dictionaryTrie||!dictionaryTrie.search(e,!0))return;e.length>=3&&dictionaryTrie.search(e)&&l.add(e);const[s,a]=[t%GRID_COLS,Math.floor(t/GRID_COLS)];for(let r=-1;r<=1;r++)for(let i=-1;i<=1;i++){if(0===r&&0===i)continue;const[c,d]=[s+r,a+i];const h=d*GRID_COLS+c;c>=0&&c<GRID_COLS&&d>=0&&d<GRID_COLS&&!o.includes(h)&&findWordsRecursive(h,e,[...o,h],l,n)}}
    
    async function getPlayerDailyRank(finalScore) {
        if (!db || !userId) return null;

        const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
        const dailyRef = collection(db, `dailyScores/${today}/entries`);
        const q = query(dailyRef);
        const snapshot = await getDocs(q);

        if (snapshot.empty) return 1; 

        const dailyHighScores = new Map();
        snapshot.forEach(doc => {
            const { userId: entryUserId, name, score } = doc.data();
            if(!entryUserId || !name || typeof score !== 'number') return;
            if (!dailyHighScores.has(entryUserId) || score > dailyHighScores.get(entryUserId).score) {
                dailyHighScores.set(entryUserId, { name, score, userId: entryUserId });
            }
        });
        
        // Ensure the current player's submitted score is in the list for ranking
        if (!dailyHighScores.has(userId) || finalScore > dailyHighScores.get(userId).score) {
             const playerDoc = await getDoc(doc(db, "players", userId));
             const playerName = playerDoc.exists() ? playerDoc.data().name : 'Anonymous';
             dailyHighScores.set(userId, { name: playerName, score: finalScore, userId: userId });
        }

        const highScoresList = [...dailyHighScores.values()].sort((a, b) => b.score - a.score);
        const rankIndex = highScoresList.findIndex(entry => entry.userId === userId);

        return rankIndex !== -1 ? rankIndex + 1 : null;
    }

    async function showEndGameScreen() {
        gameContentEl.classList.add('blurred');
        endGameModal.classList.remove('hidden');

        const sortedWords = [...foundWords].sort((a,b)=>b.score-a.score);
        const foundWordsHTML = sortedWords.length ? sortedWords.map(fw => `<div class="flex justify-between text-sm p-1 ${sortedWords.indexOf(fw) % 2 === 0 ? 'bg-slate-50' : ''} rounded"><span class="font-semibold">${fw.word.toUpperCase()}</span><span>+${fw.score}</span></div>`).join('') : '<p class="text-sm text-slate-500 text-center py-4">No words found.</p>';

        endGameModalContent.innerHTML = `<div class="bg-white rounded-2xl shadow-2xl p-6 text-center w-full max-w-sm mx-auto modal-enter">
                <h2 class="text-3xl font-black text-green-500">Great Game!</h2>
                <p class="text-slate-600 mb-2">Your final score is:</p>
                <p class="text-6xl font-black text-slate-800 mb-4">${score}</p>
                <div id="submission-container" class="h-12 flex items-center justify-center"></div>
                <div class="text-left w-full mt-4">
                    <h3 class="text-xl font-bold text-slate-700 mb-2 border-b pb-2">Your Words (${foundWords.length})</h3>
                    <div class="space-y-1 max-h-48 overflow-y-auto pr-2">${foundWordsHTML}</div>
                </div>
                <div class="flex space-x-2 mt-6">
                    <button id="endgame-leaderboard-button" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-4 rounded-lg flex-1">Leaderboard</button>
                    <button id="play-again-button" class="bg-green-500 hover:bg-green-600 w-full text-white font-bold py-3 px-4 rounded-lg text-lg shadow-lg transition-transform hover:scale-105 flex-1">Play Again</button>
                </div>
            </div>`;
            
        document.getElementById('play-again-button').onclick = resetGame;
        document.getElementById('endgame-leaderboard-button').onclick = showLeaderboardModal;

        const submissionContainer = document.getElementById('submission-container');
        submissionContainer.innerHTML = `<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-900"></div>`;

        let playerName = null;
        let showSubmitForm = true;

        if (db && userId) {
            const playerDoc = await getDoc(doc(db, "players", userId));
            if (playerDoc.exists() && playerDoc.data().name && playerDoc.data().name !== 'Anonymous') {
                playerName = playerDoc.data().name;
                showSubmitForm = false;
            }
        }
        
        if (!showSubmitForm) {
            await submitLeaderboardScore(playerName, score);
            const rank = await getPlayerDailyRank(score);
            let message = `Score submitted as <strong>${playerName}</strong>!`;
            if (rank) {
                message = `You placed <strong>#${rank}</strong> on today's leaderboard!`;
            }
            submissionContainer.innerHTML = `<div class="flex items-center justify-center text-green-600 font-bold pop-in"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>${message}</span></div>`;
        } else {
            submissionContainer.innerHTML = `<div id="submit-score-form" class="w-full"><div class="flex space-x-2"><input type="text" id="player-name" placeholder="Enter your name" class="w-full px-3 py-2 border border-slate-300 rounded-lg" maxlength="10"><button id="submit-global-score" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Submit</button></div></div>`;
            const nameInput = document.getElementById('player-name'); 
            nameInput.value = localStorage.getItem('wordRushPlayerName') || '';
            document.getElementById('submit-global-score').onclick = async (e) => { 
                const button = e.target; 
                button.disabled = true; button.textContent = '...'; 
                const newPlayerName = nameInput.value.trim(); 
                if (newPlayerName) { 
                    await submitLeaderboardScore(newPlayerName, score); 
                    const rank = await getPlayerDailyRank(score);
                    let message = `Score submitted as <strong>${newPlayerName}</strong>!`;
                    if (rank) {
                       message = `You placed <strong>#${rank}</strong> on today's leaderboard!`;
                    }
                    submissionContainer.innerHTML = `<div class="flex items-center justify-center text-green-600 font-bold pop-in"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>${message}</span></div>`;
                } else { 
                    button.disabled = false; button.textContent = 'Submit'; 
                } 
            };
        }
    }

    function setupTutorial() {
        const container = document.getElementById('how-to-play-container'); if (!container) return;
        container.innerHTML = `<div class="relative w-full h-full flex flex-col"><h3 class="text-md font-bold text-slate-700 text-center mb-2">How to Play</h3><div class="relative flex-grow flex overflow-hidden" id="tutorial-slider" style="touch-action: pan-y;"><div class="w-full flex-shrink-0 transition-transform duration-300 p-2 flex flex-col justify-center items-center"><div id="tutorial-word-builder" class="h-8 mb-2 w-32 bg-white rounded-md flex items-center justify-center space-x-0.5 shadow-inner"><span class="opacity-0">W</span></div><div id="tutorial-grid-container" class="relative w-32 h-32"><canvas id="tutorial-line-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none" style="z-index: 5;"></canvas><div class="grid grid-cols-4 gap-1">${['W','A','R','D','O','R','D','E','B','N','M','I','S','L','P','T'].map(l => `<div class="tutorial-tile w-8 h-8 flex items-center justify-center font-bold text-base bg-white rounded-md border-2 border-slate-300">${l}<sub class="text-[0.55rem] font-semibold ml-0.5">${letterConfig[l]?letterConfig[l].p:1}</sub></div>`).join('')}</div></div><p class="text-center text-xs font-semibold text-slate-700 mt-4">Touch and drag to form words (3+ letters)!</p></div><div class="w-full flex-shrink-0 transition-transform duration-300 p-4 flex flex-col justify-center text-left"><ul class="text-xs space-y-2 mb-4"><li class="flex items-start"><span class="mr-2 text-lg">üèÜ</span><span><strong>Your Goal:</strong> Score as many points as you can in 60 seconds!</span></li><li class="flex items-start"><span class="mr-2 text-lg">üëâ</span><span><strong>How to Score:</strong> Your score is the sum of letter points and any bonuses.</span></li><li class="flex items-start"><span class="mr-2 text-lg">‚≠ê</span><span><strong>Pro-Tip:</strong> Use bonuses and long words to maximize your score!</span></li></ul><div class="text-xs space-y-2"><div><strong class="font-semibold text-slate-700">Bonus Tiles:</strong><div class="grid grid-cols-2 gap-x-4 mt-1"><ul class="list-none space-y-1"><li class="flex items-center"><span><span class="inline-block text-white text-center font-bold rounded px-1.5 py-0.5 mr-2 w-8" style="background-color: #3b82f6;">DL</span> Double Letter</span></li><li class="flex items-center"><span><span class="inline-block text-white text-center font-bold rounded px-1.5 py-0.5 mr-2 w-8" style="background-color: #ef4444;">TL</span> Triple Letter</span></li></ul><ul class="list-none space-y-1"><li class="flex items-center"><span><span class="inline-block text-white text-center font-bold rounded px-1.5 py-0.5 mr-2 w-8" style="background-color: #f59e0b;">DW</span> Double Word</span></li><li class="flex items-center"><span><span class="inline-block text-white text-center font-bold rounded px-1.5 py-0.5 mr-2 w-8" style="background-color: #22c55e;">+5s</span> Extra Time</span></li></ul></div></div></div></div><div class="w-full flex-shrink-0 transition-transform duration-300 p-4 flex flex-col justify-start text-left"><div class="text-xs space-y-3"><div><strong class="font-semibold text-slate-700">Long Word Bonus:</strong><table class="w-full mt-1 text-left text-xs"><tbody><tr><td class="py-0.5 pr-2">4 Letters: <span class="font-medium">+2 pts</span></td><td class="py-0.5">6 Letters: <span class="font-medium">+10 pts</span></td></tr><tr><td class="py-0.5 pr-2">5 Letters: <span class="font-medium">+5 pts</span></td><td class="py-0.5">7+ Letters: <span class="font-medium">+20 pts</span></td></tr></tbody></table></div><div class="pt-2"><strong class="font-semibold text-slate-700">Letter Point Values:</strong><div id="letter-values-container" class="flex flex-wrap gap-1 mt-1"></div></div></div></div></div><div class="flex justify-center items-center space-x-2 mt-2"><div id="tutorial-dots" class="flex space-x-1.5"></div></div></div>`;
        const letterValuesContainer = container.querySelector('#letter-values-container'); if (letterValuesContainer) { const sortedLetters = Object.keys(letterConfig).sort(); const letterTilesHtml = sortedLetters.map(letter => { const config = letterConfig[letter]; return `<span class="bg-slate-200 text-slate-700 font-bold rounded-sm px-1.5 py-0.5 text-[10px] leading-none">${letter}-${config.p}</span>`; }).join(''); letterValuesContainer.innerHTML = letterTilesHtml; }
        let currentPage = 0; const slider = container.querySelector('#tutorial-slider'); const pages = container.querySelectorAll('#tutorial-slider > div'); const dotsContainer = container.querySelector('#tutorial-dots'); let touchStartX = 0; let touchEndX = 0; let isDragging = false; let animationInterval;
        for (let i = 0; i < pages.length; i++) { const dot = document.createElement('div'); dot.className = 'w-2 h-2 rounded-full bg-slate-400 transition-colors cursor-pointer'; dot.onclick = () => { currentPage = i; updateTutorialView(); }; dotsContainer.appendChild(dot); }
        const dots = dotsContainer.children; const updateTutorialView = () => { pages.forEach((page, i) => { page.style.transform = `translateX(${-100 * currentPage}%)`; }); Array.from(dots).forEach((dot, i) => { dot.classList.toggle('bg-blue-500', i === currentPage); dot.classList.toggle('bg-slate-400', i !== currentPage); }); };
        const handleSwipe = () => { const swipeDiff = touchStartX - touchEndX; if (swipeDiff > 50) { if (currentPage < pages.length - 1) currentPage++; } else if (swipeDiff < -50) { if (currentPage > 0) currentPage--; } updateTutorialView(); };
        slider.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true }); slider.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }); slider.addEventListener('mousedown', e => { isDragging = true; touchStartX = e.clientX; slider.style.cursor = 'grabbing'; }); slider.addEventListener('mouseup', e => { if(isDragging) { isDragging = false; touchEndX = e.clientX; handleSwipe(); slider.style.cursor = 'grab'; } }); slider.addEventListener('mouseleave', e => { if(isDragging) { isDragging = false; slider.style.cursor = 'grab'; } }); updateTutorialView();
        const tutorialGridContainer = container.querySelector('#tutorial-grid-container'); const tutorialCanvas = container.querySelector('#tutorial-line-canvas'); const tutorialCtx = tutorialCanvas.getContext('2d'); const tutorialTiles = Array.from(tutorialGridContainer.querySelectorAll('.tutorial-tile')); const wordBuilder = container.querySelector('#tutorial-word-builder'); const animationSequence = [0, 4, 5, 10]; const word = 'WORM';
        const runAnimation = () => { const gridRect = tutorialGridContainer.getBoundingClientRect(); tutorialCanvas.width = gridRect.width; tutorialCanvas.height = gridRect.height; const tileCenters = tutorialTiles.map(tile => { const tileRect = tile.getBoundingClientRect(); return { x: tileRect.left + tileRect.width / 2 - gridRect.left, y: tileRect.top + tileRect.height / 2 - gridRect.top }; }); wordBuilder.innerHTML = '<span class="opacity-0">W</span>'; tutorialTiles.forEach(t => t.classList.remove('highlight')); tutorialCtx.clearRect(0, 0, tutorialCanvas.width, tutorialCanvas.height); let scoreEl = tutorialGridContainer.querySelector('.flying-score-tutorial'); if(scoreEl) scoreEl.remove(); const pathPoints = []; animationSequence.forEach((tileIndex, step) => { setTimeout(() => { tutorialTiles[tileIndex].classList.add('highlight'); const newLetterHTML = `<span class="current-letter bg-white text-blue-500 font-bold text-sm px-1 py-0.5 rounded-md shadow-sm">${word[step]}</span>`; if (step === 0) { wordBuilder.innerHTML = newLetterHTML; } else { wordBuilder.innerHTML += newLetterHTML; } pathPoints.push(tileCenters[tileIndex]); tutorialCtx.clearRect(0, 0, tutorialCanvas.width, tutorialCanvas.height); if(pathPoints.length > 1) { tutorialCtx.beginPath(); tutorialCtx.strokeStyle = 'rgba(59, 130, 246, 0.8)'; tutorialCtx.lineWidth = 8; tutorialCtx.lineCap = 'round'; tutorialCtx.lineJoin = 'round'; tutorialCtx.moveTo(pathPoints[0].x, pathPoints[0].y); for(let i = 1; i < pathPoints.length; i++) { tutorialCtx.lineTo(pathPoints[i].x, pathPoints[i].y); } tutorialCtx.stroke(); } }, 1000 + (step + 1) * 750); }); setTimeout(() => { const el = document.createElement('div'); el.className = 'flying-score'; el.style.fontSize = '1rem'; el.style.padding = '4px 8px'; el.style.animation = 'fly-up-tutorial 1.5s ease-in-out forwards'; el.style.position = 'absolute'; el.style.top = '50%'; el.style.left = '50%'; el.textContent = `+9`; el.classList.add('flying-score-tutorial'); tutorialGridContainer.appendChild(el); }, 1000 + (animationSequence.length + 1) * 750); };
        if(animationInterval) clearInterval(animationInterval); setTimeout(() => { runAnimation(); animationInterval = setInterval(runAnimation, 6000); }, 350);
    };

    document.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>
